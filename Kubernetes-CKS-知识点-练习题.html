<!DOCTYPE html>
<html lang="en">

<!-- Head tag -->
<head><meta name="generator" content="Hexo 3.9.0">
    <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google-site-verification" content="4aJ9pFEKjOcI9zlltw5NYLKMsnk_Ygy49okv3PcTknw">
    <meta name="baidu-site-verification" content="JFD0vIDsbS">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content>
    <meta name="keyword" content>
    <link rel="shortcut icon" href="/img/cat-icon-512.png">
    <!-- Place this tag in your head or just before your close body tag. -->
    <script async defer src="https://buttons.github.io/buttons.js"></script>
    <title>
        
          Kubernetes CKS 知识点&amp;练习题 - Yuankun | Zilan
        
    </title>

    <link rel="canonical" href="http://liyuankun.top/Kubernetes-CKS-知识点-练习题.html">

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    <!-- Custom CSS --> 
    <!-- <link rel="stylesheet" href="/css/zilan.min.css"> -->
    <link rel="stylesheet" href="/css/zilan.css">
    
    <!-- Pygments Highlight CSS -->
    <link rel="stylesheet" href="/css/highlight.css">

    <link rel="stylesheet" href="/css/widget.css">

    <link rel="stylesheet" href="/css/rocket.css">

    <link rel="stylesheet" href="/css/signature.css">

    <link rel="stylesheet" href="/css/toc.css">

    <link rel="stylesheet" href="/css/share.css">

    <link rel="stylesheet" href="/css/gitment.css">

    <link rel="stylesheet" href="/css/copyright.css">

    <link rel="stylesheet" href="/css/search/localsearch.css">

    <!-- Custom Fonts -->
    <!-- <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css"> -->
    <!-- Hux change font-awesome CDN to qiniu -->
    <link href="https://cdn.staticfile.org/font-awesome/4.5.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">


    <!-- Hux Delete, sad but pending in China
    <link href='http://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/
    css'>
    -->


    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- ga & ba script hoook -->
    <script></script><!-- hexo-inject:begin --><!-- hexo-inject:end -->
</head>


<!-- hack iOS CSS :active style -->
<body ontouchstart="">
	<!-- hexo-inject:begin --><!-- hexo-inject:end --><!-- Post Header -->
<style type="text/css">
    header.intro-header{
        
            background-image: url('');
            /*post*/
        
    }
    
        #signature{
            background-image: url('/img/signature/signature-white.png');
        }
    

    
        #header-cover {
            background-color: rgba(0,0,0,.2);
        }
    
</style>

<header class="intro-header" >
    <div id="header-cover">
        <!-- Signature -->
        <div id="signature">
            <div class="container">
                <div class="row">
                    <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                    
                        <div class="post-heading">
                            <div class="tags">
                                
                                <a class="tag" href="/tags/#Cloud" title="Cloud">Cloud</a>
                                
                                <a class="tag" href="/tags/#container" title="container">container</a>
                                
                            </div>
                            <!-- category post header -->
                            
                                <div class="page-header-category">
                                    <a class="category-list-link" href="/categories/TECH/">TECH</a>►<a class="category-list-link" href="/categories/TECH/container/">container</a>
                                </div>
                            
                            
                                <span class="post-comments-count">
                                    <span class="post-meta-divider">|</span>
                                    <a href="/Kubernetes-CKS-知识点-练习题.html#git_comment" rel="external nofollow" itemprop="discussionUrl">
                                        <span class="post-meta-item-icon">
                                            <i class="fa fa-comment-o"></i>
                                        </span>
                                        <span class="post-comments-count gitment-comments-count" data-xid="/Kubernetes-CKS-知识点-练习题.html" itemprop="commentsCount"></span>
                                    </a>
                                </span>
                            
                            <h1>
                                Kubernetes CKS 知识点&amp;练习题
                                <!-- Share -->
                                
                                    <span id="needsharebutton-postbottom" class="header-share">
                                        <span class="btn">
                                            <i class="fa fa-share-alt" aria-hidden="true"></i>
                                        </span>
                                    </span>
                                
                            </h1>
                            <h2 class="subheading">Certified Kubernetes Security Specialist</h2>
                            <span class="meta">
                                Posted by Yuankun Li on
                                2023-02-04
                            </span>
                        </div>
                    
                    </div>
                </div>
            </div>
        </div>
    </div>
</header>

	
    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">岚</a>
            <!-- Search -->
            
            
                <li class="menu-item menu-item-search">
                
                    <a href="javascript:;" class="popup-trigger">
                
                    
                        <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
                    
                </a>
                </li>
            
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <!-- Known Issue, found by Hux:
            <nav>'s height woule be hold on by its content.
            so, when navbar scale out, the <nav> will cover tags.
            also mask any touch event of tags, unfortunately.
        -->
        <div id="huxblog_navbar">
            <div class="navbar-collapse">
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="/">Home</a>
                    </li>

                    

                        
                    

                        
                        <li>
                            <a href="/about/">About</a>
                        </li>
                        
                    

                        
                        <li>
                            <a href="/categories/">Categories</a>
                        </li>
                        
                    

                        
                        <li>
                            <a href="/archive/">Archives</a>
                        </li>
                        
                    

                        
                        <li>
                            <a href="/tags/">Tags</a>
                        </li>
                        
                    
                    
                </ul>
            </div>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>
<script>
    // Drop Bootstarp low-performance Navbar
    // Use customize navbar with high-quality material design animation
    // in high-perf jank-free CSS3 implementation
    var $body   = document.body;
    var $toggle = document.querySelector('.navbar-toggle');
    var $navbar = document.querySelector('#huxblog_navbar');
    var $collapse = document.querySelector('.navbar-collapse');

    $toggle.addEventListener('click', handleMagic)
    function handleMagic(e){
        if ($navbar.className.indexOf('in') > 0) {
        // CLOSE
            $navbar.className = " ";
            // wait until animation end.
            setTimeout(function(){
                // prevent frequently toggle
                if($navbar.className.indexOf('in') < 0) {
                    $collapse.style.height = "0px"
                }
            },400)
        }else{
        // OPEN
            $collapse.style.height = "auto"
            $navbar.className += " in";
        }
    }
</script>


    <!-- Main Content -->
    <!-- Post Content -->
<div id="container">
    <article>
        <div class="container post-content-container">
            <div class="row">

                <!-- One Post Content Container -->
                <div class="
                    col-lg-8 col-lg-offset-2
                    col-md-10 col-md-offset-1
                    post-container">

                    <h2 id="pod-security-policies-psp">Pod Security Policies(PSP)</h2>
<p>Reference:</p>
<ul>
<li><a href="https://kubernetes.io/docs/concepts/security/pod-security-policy/" target="_blank" rel="noopener">k8s Pod Security Policy官方文档</a>
<ul>
<li><a href="https://kubernetes.io/zh-cn/blog/2021/04/06/podsecuritypolicy-deprecation-past-present-and-future/" target="_blank" rel="noopener">PodSecurityPolicy Deprecation: Past, Present, and Future</a></li>
</ul>
</li>
<li><a href="https://docs.aws.amazon.com/eks/latest/userguide/pod-security-policy.html" target="_blank" rel="noopener">aws eks 官方文档</a></li>
<li><a href="https://www.appvia.io/blog/podsecuritypolicy-is-dead-long-live/" target="_blank" rel="noopener">PodSecurityPolicy is Dead, Long Live…?</a></li>
<li><a href="https://docs.bitnami.com/kubernetes/faq/configuration/understand-pod-security-policies/" target="_blank" rel="noopener">https://docs.bitnami.com/kubernetes/faq/configuration/understand-pod-security-policies/</a></li>
</ul>
<blockquote>
<p>Removed feature<br>
PodSecurityPolicy was deprecated in Kubernetes <code>v1.21</code>, and removed from Kubernetes in <code>v1.25</code>.<br>
Use <a href="https://kubernetes.io/docs/concepts/security/pod-security-admission/" target="_blank" rel="noopener"><code>Pod Security Admission</code></a>instead.</p>
</blockquote>
<p>A Pod Security Policy is a <strong>cluster-level</strong> resource that controls security sensitive aspects of the <strong>pod</strong> specification.</p>
<h2 id="apparmor"><a href="https://kubernetes.io/docs/tutorials/security/apparmor/" target="_blank" rel="noopener">AppArmor</a></h2>
<p><a href="https://blog.csdn.net/cloud_engineer/article/details/125659959" target="_blank" rel="noopener">kubernetes CKS 3.2 AppArmor限制容器对资源访问</a></p>
<p><a href="https://killercoda.com/killer-shell-cks/scenario/apparmor" target="_blank" rel="noopener">Manage AppArmor profiles and Pods using these</a></p>
<p><img src="https://github.com/CatherineLiyuankun/PictureBed/raw/master/blog/post/CKS/AppArmor1-Check%20existing%20AppArmor%20profiles.png" alt="apparmor1"></p>
<p><img src="https://github.com/CatherineLiyuankun/PictureBed/raw/master/blog/post/CKS/AppArmor2-deployment.png" alt="apparmor1"></p>
<p><img src="https://github.com/CatherineLiyuankun/PictureBed/raw/master/blog/post/CKS/AppArmor2-deployment2.png" alt="AppArmor2-deployment2.png"></p>
<p><img src="https://github.com/CatherineLiyuankun/PictureBed/raw/master/blog/post/CKS/AppArmor2-deployment3beforeChange.png" alt="AppArmor2-deployment3beforeChange.png"></p>
<p><img src="https://github.com/CatherineLiyuankun/PictureBed/raw/master/blog/post/CKS/AppArmor2-deployment4.png" alt="AppArmor2-deployment4.png"></p>
<p><img src="https://github.com/CatherineLiyuankun/PictureBed/raw/master/blog/post/CKS/AppArmor2-deployment5.png" alt="AppArmor2-deployment5.png"></p>
<p><img src="https://github.com/CatherineLiyuankun/PictureBed/raw/master/blog/post/CKS/AppArmor3-install%20profile.png" alt="AppArmor3-install profile.png"></p>
<h2 id="apiserver-crash">Apiserver Crash</h2>
<p><a href="https://killercoda.com/killer-shell-cks/scenario/apiserver-crash" target="_blank" rel="noopener">Crash that Apiserver and check them logs</a></p>
<p>kube-apiserver.yaml Location: <code>/etc/kubernetes/manifests/kube-apiserver.yaml</code></p>
<p>Log locations to check:</p>
<ul>
<li><code>/var/log/pods</code></li>
<li><code>/var/log/containers</code></li>
<li><code>crictl ps</code> + <code>crictl logs</code></li>
<li><code>docker ps</code> + <code>docker logs</code> (in case when Docker is used)</li>
<li>kubelet logs: <code>/var/log/syslog</code> or <code>journalctl</code></li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># smart people use a backup</span></span><br><span class="line">cp ~/kube-apiserver.yaml.ori /etc/kubernetes/manifests/kube-apiserver.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># wait till container restarts</span></span><br><span class="line">watch crictl ps</span><br><span class="line"></span><br><span class="line"><span class="comment"># check for apiserver pod</span></span><br><span class="line">k -n kube-system get pod</span><br></pre></td></tr></table></figure>
<p>Give the Apiserver some time to restart itself, like 1-2 minutes. If it doesn’t restart by itself you can also force it with:</p>
<ul>
<li>1: <code>mv /etc/kubernetes/manifests/kube-apiserver.yaml /tmp/kube-apiserver.yaml</code></li>
<li>2: wait till container is removed with <code>watch crictl ps</code></li>
<li>3: <code>mv /tmp/kube-apiserver.yaml /etc/kubernetes/manifests/kube-apiserver.yaml</code></li>
</ul>
<h3 id="configure-a-wrong-argument">Configure a wrong argument</h3>
<p>The idea here is to misconfigure the Apiserver in different ways, then check possible log locations for errors.</p>
<p>You should be very comfortable with situations where the Apiserver is not coming back up.</p>
<p>Configure the Apiserver manifest with a new argument <code>--this-is-very-wrong</code> .</p>
<p>Check if the Pod comes back up and what logs this causes.</p>
<p>Fix the Apiserver again.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># always make a backup !</span></span><br><span class="line">cp /etc/kubernetes/manifests/kube-apiserver.yaml ~/kube-apiserver.yaml.ori</span><br><span class="line"></span><br><span class="line"><span class="comment"># make the change</span></span><br><span class="line">vim /etc/kubernetes/manifests/kube-apiserver.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># wait till container restarts</span></span><br><span class="line">watch crictl ps</span><br><span class="line"></span><br><span class="line"><span class="comment"># check for apiserver pod</span></span><br><span class="line">k -n kube-system get pod</span><br></pre></td></tr></table></figure>
<p>Apiserver is not coming back, we messed up!</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># check pod logs</span></span><br><span class="line">cat /var/<span class="built_in">log</span>/pods/kube-system_kube-apiserver-controlplane_a3a455d471f833137588e71658e739da/kube-apiserver/X.log</span><br><span class="line">&gt; 2022-01-26T10:41:12.401641185Z stderr F Error: unknown flag: --this-is-very-wrong</span><br></pre></td></tr></table></figure>
<p>Now undo the change and continue</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># smart people use a backup</span></span><br><span class="line">cp ~/kube-apiserver.yaml.ori /etc/kubernetes/manifests/kube-apiserver.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># wait till container restarts</span></span><br><span class="line">watch crictl ps</span><br><span class="line"></span><br><span class="line"><span class="comment"># check for apiserver pod</span></span><br><span class="line">k -n kube-system get pod</span><br></pre></td></tr></table></figure>
<h3 id="misconfigure-etcd-connection">Misconfigure ETCD connection</h3>
<p>Change the existing Apiserver manifest argument to: <code>--etcd-servers=this-is-very-wrong</code> .</p>
<p>Check what the logs say, without using anything in <code>/var</code> .</p>
<p>Fix the Apiserver again.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># always make a backup !</span></span><br><span class="line">cp /etc/kubernetes/manifests/kube-apiserver.yaml ~/kube-apiserver.yaml.ori</span><br><span class="line"></span><br><span class="line"><span class="comment"># make the change</span></span><br><span class="line">vim /etc/kubernetes/manifests/kube-apiserver.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># wait till container restarts</span></span><br><span class="line">watch crictl ps</span><br><span class="line"></span><br><span class="line"><span class="comment"># check for apiserver pod</span></span><br><span class="line">k -n kube-system get pod</span><br></pre></td></tr></table></figure>
<p>Apiserver is not coming back, we messed up!</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1) if we would check the /var directory</span></span><br><span class="line">cat /var/<span class="built_in">log</span>/pods/kube-system_kube-apiserver-controlplane_e24b3821e9bdc47a91209bfb04056993/kube-apiserver/X.log</span><br><span class="line">&gt; Err: connection error: desc = <span class="string">"transport: Error while dialing dial tcp: address this-is-very-wrong: missing port in address"</span>. Reconnecting...</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2) but here we want to find other ways, so we check the container logs</span></span><br><span class="line">crictl ps <span class="comment"># maybe run a few times, because the apiserver container get's restarted</span></span><br><span class="line">CONTAINER           IMAGE               CREATED             STATE               NAME                      ATTEMPT             POD ID              POD</span><br><span class="line">062e4db76ac48       a31e1d84401e6       10 minutes ago      Running             kube-apiserver            0                   2641ca9ecc8ee       kube-apiserver-controlplane</span><br><span class="line"></span><br><span class="line">crictl logs 2641ca9ecc8ee <span class="comment"># pod ID</span></span><br><span class="line">&gt; Error <span class="keyword">while</span> dialing dial tcp: address this-is-very-wrong: missing port <span class="keyword">in</span> address. Reconnecting...</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3) what about syslogs</span></span><br><span class="line">journalctl | grep apiserver <span class="comment"># nothing specific</span></span><br><span class="line">cat /var/<span class="built_in">log</span>/syslog | grep apiserver <span class="comment"># nothing specific</span></span><br></pre></td></tr></table></figure>
<p>Now undo the change and continue</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># smart people use a backup</span></span><br><span class="line">cp ~/kube-apiserver.yaml.ori /etc/kubernetes/manifests/kube-apiserver.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># wait till container restarts</span></span><br><span class="line">watch crictl ps</span><br><span class="line"></span><br><span class="line"><span class="comment"># check for apiserver pod</span></span><br><span class="line">k -n kube-system get pod</span><br></pre></td></tr></table></figure>
<h3 id="invalid-apiserver-manifest-yaml">Invalid Apiserver Manifest YAML</h3>
<p>Change the Apiserver manifest and add invalid YAML, something like this:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersionTHIS IS VERY :::::</span> <span class="string">WRONG</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br></pre></td></tr></table></figure>
<p>Check what the logs say, and fix again.</p>
<p>Fix the Apiserver again.</p>
<p>Apiserver is not coming back, we messed up!</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># seems like the kubelet can't even create the apiserver pod/container</span></span><br><span class="line">/var/<span class="built_in">log</span>/pods <span class="comment"># nothing</span></span><br><span class="line">crictl logs <span class="comment"># nothing</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># syslogs:</span></span><br><span class="line">tail -f /var/<span class="built_in">log</span>/syslog | grep apiserver</span><br><span class="line">&gt; Could not process manifest file err=<span class="string">"/etc/kubernetes/manifests/kube-apiserver.yaml: couldn't parse as pod(yaml: mapping values are not allowed in this context), please check config file"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># or:</span></span><br><span class="line">journalctl | grep apiserver</span><br><span class="line">&gt; Could not process manifest file<span class="string">" err="</span>/etc/kubernetes/manifests/kube-apiserver.yaml: couldn<span class="string">'t parse as pod(yaml: mapping values are not allowed in this context), please check config file</span></span><br></pre></td></tr></table></figure>
<h2 id="apiserver-misconfigured">Apiserver Misconfigured</h2>
<p><a href="https://killercoda.com/killer-shell-cks/scenario/apiserver-misconfigured" target="_blank" rel="noopener">https://killercoda.com/killer-shell-cks/scenario/apiserver-misconfigured</a></p>
<p>Make sure to have solved the previous Scenario Apiserver Crash.<br>
The Apiserver is not coming up, the manifest is misconfigured in <code>3</code> places. Fix it.</p>
<h3 id="issues">Issues</h3>
<p>For your changes to apply you might have to:</p>
<p>move the kube-apiserver.yaml out of the manifests directory<br>
wait for apiserver container to be gone (watch crictl ps )<br>
move the manifest back in and wait for apiserver coming back up<br>
Some users report that they need to restart the kubelet (service kubelet restart ) but in theory this shouldn’t be necessary.</p>
<h3 id="solution-1">Solution 1</h3>
<p>The kubelet cannot even create the Pod/Container. Check the kubelet logs in syslog for issues.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat /var/<span class="built_in">log</span>/syslog | grep kube-apiserver</span><br></pre></td></tr></table></figure>
<p>There is wrong YAML in the manifest at <code>metadata;</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/kubernetes/manifests/kube-apiserver.yaml</span><br><span class="line"></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:  <span class="comment"># `metadata;` 改为 "metadata:"</span></span><br></pre></td></tr></table></figure>
<h3 id="solution-2">Solution 2</h3>
<p>After fixing the wrong YAML there still seems to be an issue with a wrong parameter.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Check logs in `/var/log/pods`.</span></span><br><span class="line"><span class="built_in">cd</span> /var/<span class="built_in">log</span>/pods</span><br><span class="line"><span class="built_in">cd</span> /kube-system_kube-apiserver-controlplane_24f6c7045a5830f4ff3dd5c63e8bd9cb/kube-apiserver/</span><br><span class="line">ls</span><br><span class="line">    5.log</span><br><span class="line">cat 5.log</span><br><span class="line">    Error: Error: unknown flag: --authorization-modus.</span><br><span class="line"><span class="comment"># The correct parameter is --authorization-mode.</span></span><br><span class="line">vim /etc/kubernetes/manifests/kube-apiserver.yaml</span><br><span class="line">    - --authorization-mode=Node,RBAC <span class="comment"># 修改--authorization-modus</span></span><br></pre></td></tr></table></figure>
<h3 id="solution-3">Solution 3</h3>
<p>After fixing the wrong parameter, the pod/container might be up, but gets restarted.</p>
<p>Check container logs or /var/log/pods, where we should find:</p>
<p>Error while dialing dial tcp 127.0.0.1:23000: connect:connection refused</p>
<p>Check the container logs: the ETCD connection seems to be wrong. Set the correct port on which ETCD is running (check the ETCD manifest)</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/kubernetes/manifests/kube-apiserver.yaml</span><br><span class="line">  - --etcd-servers=https://127.0.0.1:2379 <span class="comment"># 修改--etcd-servers=https://127.0.0.1:23000 为--etcd-servers=https://127.0.0.1:2379</span></span><br></pre></td></tr></table></figure>
<h2 id="apiserver-noderestriction"><a href="https://killercoda.com/killer-shell-cks/scenario/apiserver-node-restriction" target="_blank" rel="noopener">Apiserver NodeRestriction</a></h2>
<p><a href="https://killercoda.com/killer-shell-cks/scenario/apiserver-node-restriction" target="_blank" rel="noopener">admission controller - Use the NodeRestriction Admission Controller to restrict Kubelet’s permissions</a></p>
<h3 id="verify-the-issue">Verify the issue</h3>
<p>The Kubelet on <code>node01</code> shouldn’t be able to set Node labels</p>
<ul>
<li>starting with <code>node-restriction.kubernetes.io/*</code></li>
<li>on other Nodes than itself （不能label其他node，只能label本node：<code>node01</code>）</li>
</ul>
<p>Verify this is not restricted atm by performing the following actions as the Kubelet from node01 :</p>
<ul>
<li>add label <code>killercoda/one=123</code> to Node <code>controlplane</code></li>
<li>add label <code>node-restriction.kubernetes.io/one=123</code> to Node <code>node01</code></li>
</ul>
<h4 id="tip">Tip</h4>
<p>We can contact the Apiserver as the Kubelet by using the Kubelet kubeconfig</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> KUBECONFIG=/etc/kubernetes/kubelet.conf</span><br><span class="line">k get node</span><br></pre></td></tr></table></figure>
<h4 id="solution">Solution</h4>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">ssh node01</span><br><span class="line">    <span class="built_in">export</span> KUBECONFIG=/etc/kubernetes/kubelet.conf</span><br><span class="line">    k label node controlplane killercoda/one=123 <span class="comment"># works but should be restricted 现在可以成功加label，但是我们应该更改配置使得它满足题目要求：be restricted</span></span><br><span class="line">    node/controlplane labeled</span><br><span class="line">    k label node node01 node-restriction.kubernetes.io/one=123 <span class="comment"># works but should be restricted</span></span><br><span class="line">    node/node01 labeled</span><br><span class="line"></span><br><span class="line">    k get node --show-labels </span><br><span class="line">NAME           STATUS   ROLES           AGE   VERSION   LABELS</span><br><span class="line">controlplane   Ready    control-plane   20d   v1.25.3   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,killercoda/one=123,kubernetes.io/arch=amd64,kubernetes.io/hostname=controlplane,kubernetes.io/os=linux,node-role.kubernetes.io/control-plane=,node.kubernetes.io/exclude-from-external-load-balancers=</span><br><span class="line">node01         Ready    &lt;none&gt;          20d   v1.25.3   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/arch=amd64,kubernetes.io/hostname=node01,kubernetes.io/os=linux,node-restriction.kubernetes.io/one=123</span><br><span class="line"></span><br><span class="line"><span class="comment"># 可以看到两个label都成功加上了</span></span><br></pre></td></tr></table></figure>
<h3 id="enable-the-noderestriction-admission-controller">Enable the NodeRestriction Admission Controller</h3>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">node01 $ <span class="built_in">exit</span></span><br><span class="line"><span class="built_in">logout</span></span><br><span class="line">Connection to node01 closed.</span><br><span class="line">controlplane $ vim /etc/kubernetes/manifests/kube-apiserver.yaml</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - <span class="built_in">command</span>:</span><br><span class="line">    - kube-apiserver</span><br><span class="line">    - --advertise-address=172.30.1.2</span><br><span class="line">    - --allow-privileged=<span class="literal">true</span></span><br><span class="line">    - --authorization-mode=Node,RBAC</span><br><span class="line">    - --client-ca-file=/etc/kubernetes/pki/ca.crt</span><br><span class="line">    - --<span class="built_in">enable</span>-admission-plugins=NodeRestriction    <span class="comment"># Add this line</span></span><br><span class="line">    - --<span class="built_in">enable</span>-bootstrap-token-auth=<span class="literal">true</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">ssh node01</span><br><span class="line">    <span class="built_in">export</span> KUBECONFIG=/etc/kubernetes/kubelet.conf</span><br><span class="line">    k label node controlplane killercoda/two=123 <span class="comment"># restricted</span></span><br><span class="line">      Error from server (Forbidden): nodes <span class="string">"controlplane"</span> is forbidden: node <span class="string">"node01"</span> is not allowed to modify node <span class="string">"controlplane"</span></span><br><span class="line"></span><br><span class="line">    k label node node01 node-restriction.kubernetes.io/two=123 <span class="comment"># restricted</span></span><br><span class="line">      Error from server (Forbidden): nodes <span class="string">"node01"</span> is forbidden: is not allowed to modify labels: node-restriction.kubernetes.io/two</span><br><span class="line"></span><br><span class="line">    k label node node01 <span class="built_in">test</span>/two=123 <span class="comment"># works</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># other test</span></span><br><span class="line">    k label node controlplane <span class="built_in">test</span>/two=123</span><br><span class="line">      Error from server (Forbidden): nodes <span class="string">"controlplane"</span> is forbidden: node <span class="string">"node01"</span> is not allowed to modify node <span class="string">"controlplane"</span></span><br></pre></td></tr></table></figure>
<p>Notice that existing restricted labels won’t be removed once the NodeRestriction is enabled.</p>
<h2 id="imagepolicywebhook"><a href="https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/#imagepolicywebhook" target="_blank" rel="noopener">ImagePolicyWebhook</a></h2>
<p><a href="https://killercoda.com/killer-shell-cks/scenario/image-policy-webhook-setup" target="_blank" rel="noopener">Complete the ImagePolicyWebhook setup</a></p>
<h3 id="complete-the-imagepolicywebhook-setup">Complete the ImagePolicyWebhook setup</h3>
<p>An ImagePolicyWebhook setup has been half finished, complete it:</p>
<ol>
<li>Make sure <code>admission_config.json</code> points to correct kubeconfig</li>
<li>Set the <code>allowTTL</code> to <code>100</code></li>
<li>All Pod creation should be prevented if the external service is not reachable</li>
<li>The external service will be reachable under <code>https://localhost:1234</code> in the future. It doesn’t exist yet so it - shouldn’t be able to create any Pods till then</li>
<li>Register the correct admission plugin in the apiserver</li>
</ol>
<details>
  <summary>Solution</summary>
  <p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># find admission_config.json path in kube-apiserver.yaml</span></span><br><span class="line">vim /etc/kubernetes/manifests/kube-apiserver.yaml <span class="comment"># Find value of --admission-control-config-file</span></span><br><span class="line"><span class="comment"># or</span></span><br><span class="line">cat /etc/kubernetes/manifests/kube-apiserver.yaml | grep admission-control-config-file</span><br><span class="line">    - --admission-control-config-file=/etc/kubernetes/policywebhook/admission_config.json</span><br><span class="line"></span><br><span class="line">vim /etc/kubernetes/policywebhook/admission_config.json</span><br></pre></td></tr></table></figure>
</p><p>The <code>/etc/kubernetes/policywebhook/admission_config.json</code> should look like this:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">   <span class="attr">"apiVersion"</span>: <span class="string">"apiserver.config.k8s.io/v1"</span>,</span><br><span class="line">   <span class="attr">"kind"</span>: <span class="string">"AdmissionConfiguration"</span>,</span><br><span class="line">   <span class="attr">"plugins"</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">         <span class="attr">"name"</span>: <span class="string">"ImagePolicyWebhook"</span>,</span><br><span class="line">         <span class="attr">"configuration"</span>: &#123;</span><br><span class="line">            <span class="attr">"imagePolicy"</span>: &#123;</span><br><span class="line">               <span class="attr">"kubeConfigFile"</span>: <span class="string">"/etc/kubernetes/policywebhook/kubeconf"</span>, <span class="comment">// 1.modify "kubeConfigFile": "/todo/kubeconf" to current</span></span><br><span class="line">               <span class="attr">"allowTTL"</span>: <span class="number">100</span>,  <span class="comment">// 2.modify 50 to 100</span></span><br><span class="line">               <span class="attr">"denyTTL"</span>: <span class="number">50</span>,</span><br><span class="line">               <span class="attr">"retryBackoff"</span>: <span class="number">500</span>,</span><br><span class="line">               <span class="attr">"defaultAllow"</span>: <span class="literal">false</span>   <span class="comment">// 3.modify from true to false</span></span><br><span class="line">            &#125;</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line">   ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/kubernetes/policywebhook/kubeconf</span><br></pre></td></tr></table></figure>
<p>The <code>/etc/kubernetes/policywebhook/kubeconf</code> should contain the correct server:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Config</span></span><br><span class="line"><span class="comment"># clusters refers to the remote service.</span></span><br><span class="line"><span class="attr">clusters:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">cluster:</span></span><br><span class="line">    <span class="attr">certificate-authority:</span> <span class="string">/etc/kubernetes/policywebhook/external-cert.pem</span> <span class="comment"># CA for verifying the remote service.</span></span><br><span class="line">    <span class="attr">server:</span> <span class="string">https://localhost:1234</span> <span class="comment"># 4.external service  # URL of remote service to query. Must use 'https'.</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">image-checker</span></span><br><span class="line"></span><br><span class="line"><span class="attr">contexts:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">context:</span></span><br><span class="line">    <span class="attr">cluster:</span> <span class="string">image-checker</span></span><br><span class="line">    <span class="attr">user:</span> <span class="string">api-server</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">image-checker</span></span><br><span class="line"><span class="attr">current-context:</span> <span class="string">image-checker</span></span><br><span class="line"><span class="attr">preferences:</span> <span class="string">&#123;&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># users refers to the API server's webhook configuration.</span></span><br><span class="line"><span class="attr">users:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">api-server</span></span><br><span class="line">  <span class="attr">user:</span></span><br><span class="line">    <span class="attr">client-certificate:</span> <span class="string">/etc/kubernetes/policywebhook/apiserver-client-cert.pem</span>     <span class="comment"># cert for the webhook admission controller to use</span></span><br><span class="line">    <span class="attr">client-key:</span>  <span class="string">/etc/kubernetes/policywebhook/apiserver-client-key.pem</span>             <span class="comment"># key matching the cert</span></span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></table></figure>
<p>5 The apiserver needs to be configured with the ImagePolicyWebhook admission plugin:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/kubernetes/manifests/kube-apiserver.yaml</span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">command:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">kube-apiserver</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--enable-admission-plugins=NodeRestriction,ImagePolicyWebhook</span> <span class="comment"># 5. Add ImagePolicyWebhook</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--admission-control-config-file=/etc/kubernetes/policywebhook/admission_config.json</span></span><br></pre></td></tr></table></figure>
<p>Luckily the <code>--admission-control-config-file</code> argument seems already to be configured.</p>
  <p></p>
</details>
<details>
  <summary>Test your Solution</summary>
  <p>
Wait till apiserver container restarted: 
</p><p><code>watch crictl ps</code></p>
<p>To test your solution you can simply try to create a Pod:</p>
<p><code>k run pod --image=nginx</code></p>
<p>It should throw you an error like:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Error from server (Forbidden): pods <span class="string">"pod"</span> is forbidden: Post <span class="string">"https://localhost:1234/?timeout=30s"</span>: dial tcp 127.0.0.1:1234: connect: connection refused</span><br></pre></td></tr></table></figure>
<p>Once that service would be implemented and if it would allow the Pod, the Pod could be created.</p>
  <p></p>
</details>
<h2 id="kube-bench"><a href="https://github.com/aquasecurity/kube-bench" target="_blank" rel="noopener">kube-bench</a></h2>
<p><a href="https://killercoda.com/killer-shell-cks/scenario/cis-benchmarks-kube-bench-fix-controlplane" target="_blank" rel="noopener">cis-benchmarks-kube-bench-fix-controlplane</a></p>
<ul>
<li>Api Server: <code>/etc/kubernetes/manifests/kube-apiserver.yaml</code></li>
<li>Controller Manager pod specification file <code>/etc/kubernetes/manifests/kube-controller-manager.yaml</code></li>
<li>Kubelet: <code>/var/lib/kubelet/config.yaml</code></li>
<li>etcd: <code>/etc/kubernetes/manifests/etcd.yaml</code></li>
</ul>
<h3 id="apiserver-should-be-more-conform-to-cis">Apiserver should be more conform to CIS</h3>
<p>Use <code>kube-bench</code> to ensure <code>1.2.20</code> has status <code>PASS</code>.</p>
<p>Solution</p>
<p>Check for results</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># see all</span></span><br><span class="line">kube-bench run --targets master</span><br><span class="line"></span><br><span class="line"><span class="comment"># or just see the one 推荐这种方法，输出比较少，好看关键信息</span></span><br><span class="line">kube-bench run --targets master --check 1.2.20</span><br><span class="line"></span><br><span class="line">[INFO] 1 Master Node Security Configuration</span><br><span class="line">[INFO] 1.2 API Server</span><br><span class="line">[FAIL] 1.2.20 Ensure that the --profiling argument is <span class="built_in">set</span> to <span class="literal">false</span> (Automated)</span><br><span class="line"></span><br><span class="line">== Remediations master ==</span><br><span class="line">1.2.20 Edit the API server pod specification file /etc/kubernetes/manifests/kube-apiserver.yaml</span><br><span class="line">on the master node and <span class="built_in">set</span> the below parameter.</span><br><span class="line">--profiling=<span class="literal">false</span></span><br></pre></td></tr></table></figure>
<p>Fix the <code>/etc/kubernetes/manifests/kube-apiserver.yaml</code></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">...</span></span><br><span class="line"><span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">command:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">kube-apiserver</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--profiling=false</span></span><br><span class="line"><span class="string">...</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">k8s.gcr.io/kube-apiserver:v1.22.2</span></span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></table></figure>
<p>Now wait for container to be restarted: <code>watch crictl ps</code></p>
<h3 id="controllermanager-should-be-more-conform-to-cis">ControllerManager should be more conform to CIS</h3>
<p>Use <code>kube-bench</code> to ensure <code>1.3.2</code> has status <code>PASS</code>.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 推荐这种方法，输出比较少，好看关键信息</span></span><br><span class="line">kube-bench run --targets=master --check=1.3.2</span><br><span class="line"></span><br><span class="line">[INFO] 1 Master Node Security Configuration</span><br><span class="line">[INFO] 1.3 Controller Manager</span><br><span class="line">[FAIL] 1.3.2 Ensure that the --profiling argument is <span class="built_in">set</span> to <span class="literal">false</span> (Automated)</span><br><span class="line"></span><br><span class="line">== Remediations master ==</span><br><span class="line">1.3.2 Edit the Controller Manager pod specification file /etc/kubernetes/manifests/kube-controller-manager.yaml</span><br><span class="line">on the master node and <span class="built_in">set</span> the below parameter.</span><br><span class="line">--profiling=<span class="literal">false</span></span><br></pre></td></tr></table></figure>
<p>Fix the /etc/kubernetes/manifests/kube-controller-manager.yaml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">...</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">command:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">kube-controller-manager</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--profiling=false</span></span><br><span class="line"><span class="string">...</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">k8s.gcr.io/kube-controller-manager:v1.22.2</span></span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></table></figure>
<p>Now wait for container to be restarted: <code>watch crictl ps</code></p>
<h3 id="pki-directory-should-be-more-conform-to-cis">PKI directory should be more conform to CIS</h3>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 推荐这种方法，输出比较少，好看关键信息</span></span><br><span class="line">kube-bench run --check 1.1.19 --targets=master</span><br><span class="line">[INFO] 1 Master Node Security Configuration</span><br><span class="line">[INFO] 1.1 Master Node Configuration Files</span><br><span class="line">[FAIL] 1.1.19 Ensure that the Kubernetes PKI directory and file ownership is <span class="built_in">set</span> to root:root (Automated)</span><br><span class="line"></span><br><span class="line">== Remediations master ==</span><br><span class="line">1.1.19 Run the below <span class="built_in">command</span> (based on the file location on your system) on the master node.</span><br><span class="line">For example,</span><br><span class="line">chown -R root:root /etc/kubernetes/pki/</span><br></pre></td></tr></table></figure>
<p>Fix the /etc/kubernetes/pki/</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">chgrp root /etc/kubernetes/pki/</span><br><span class="line"></span><br><span class="line"><span class="comment"># or</span></span><br><span class="line">chown -R root:root /etc/kubernetes/pki/</span><br></pre></td></tr></table></figure>
<h2 id="trivy"><a href="https://github.com/aquasecurity/trivy" target="_blank" rel="noopener">Trivy</a></h2>
<p><a href="https://killercoda.com/killer-shell-cks/scenario/image-vulnerability-scanning-trivy" target="_blank" rel="noopener">Image Vulnerability Scanning Trivy</a></p>
<h3 id="use-trivy-to-scan-images-for-known-vulnerabilities">Use trivy to scan images for known vulnerabilities</h3>
<p>Using <code>trivy</code> :<br>
Scan images in Namespaces <code>applications</code> and <code>infra</code> for the vulnerabilities <code>CVE-2021-28831</code> and <code>CVE-2016-9841</code> .</p>
<p>Scale those Deployments containing any of these down to <code>0</code> .</p>
<p>Solution:</p>
<p>First we check the applications Namespace.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># find images</span></span><br><span class="line">k -n applications get pod -oyaml | grep image:</span><br><span class="line"></span><br><span class="line"><span class="comment"># scan first deployment</span></span><br><span class="line">trivy image nginx:1.19.1-alpine-perl | grep CVE-2021-28831</span><br><span class="line">31.00 MiB / 31.00 MiB [---------------------------------------------------------------------------------------------------] 100.00% 8.41 MiB p/s 4s</span><br><span class="line">| busybox      | CVE-2021-28831   |          | 1.31.1-r9         | 1.31.1-r10    | busybox: invalid free or segmentation |</span><br><span class="line">| ssl_client   | CVE-2021-28831   | HIGH     | 1.31.1-r9         | 1.31.1-r10    | busybox: invalid free or segmentation |</span><br><span class="line"></span><br><span class="line">trivy image nginx:1.19.1-alpine-perl | grep CVE-2016-9841</span><br><span class="line"></span><br><span class="line"><span class="comment"># scan second deployment</span></span><br><span class="line">trivy image nginx:1.20.2-alpine | grep CVE-2021-28831</span><br><span class="line">trivy image nginx:1.20.2-alpine | grep CVE-2016-9841</span><br><span class="line"></span><br><span class="line"><span class="comment"># hit on the first one, so we scale down</span></span><br><span class="line">$ k -n applications get deploy</span><br><span class="line">NAME   READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">web1   2/2     2            2           6m53s</span><br><span class="line">web2   1/1     1            1           6m53s</span><br><span class="line"></span><br><span class="line">$ k -n applications get deploy web1 -oyaml | grep nginx:1.19.1-alpine-perl</span><br><span class="line">      - image: nginx:1.19.1-alpine-perl</span><br><span class="line">$ k -n applications get deploy web2 -oyaml | grep nginx:1.19.1-alpine-perl</span><br><span class="line"></span><br><span class="line">k -n applications get deploy web1 </span><br><span class="line">NAME   READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">web1   2/2     2            2           13m</span><br><span class="line"></span><br><span class="line">k -n applications scale deploy web1 --replicas 0</span><br><span class="line"></span><br><span class="line">$ k -n applications get deploy web1</span><br><span class="line">NAME   READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">web1   0/0     0            0           13m</span><br></pre></td></tr></table></figure>
<p>Next we check the infra Namespace.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># find images</span></span><br><span class="line">k -n infra get pod -oyaml | grep image:</span><br><span class="line"></span><br><span class="line"><span class="comment"># scan deployment</span></span><br><span class="line">trivy image httpd:2.4.39-alpine | grep CVE-2021-28831</span><br><span class="line">trivy image httpd:2.4.39-alpine | grep CVE-2016-9841</span><br><span class="line"></span><br><span class="line"><span class="comment"># hit, so we scale down</span></span><br><span class="line">$ k -n infra get deployments.apps </span><br><span class="line">NAME      READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">inf-hjk   3/3     3            3           16m</span><br><span class="line"></span><br><span class="line">k -n infra scale deploy inf-hjk --replicas 0</span><br><span class="line"></span><br><span class="line">$ k -n infra get deployments.apps </span><br><span class="line">NAME      READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">inf-hjk   0/0     0            0           18m</span><br></pre></td></tr></table></figure>
<h2 id="falco">Falco</h2>
<p><a href="https://killercoda.com/killer-shell-cks/scenario/falco-change-rule" target="_blank" rel="noopener">https://killercoda.com/killer-shell-cks/scenario/falco-change-rule</a></p>
<h3 id="investigate-a-falco-rule">Investigate a Falco Rule</h3>
<p>Falco has been installed on Node <code>controlplane</code> and it runs as a service.</p>
<p>It’s configured to log to <code>syslog</code>, and this is where the verification for this scenario also looks.</p>
<p>Cause the rule “shell in a container” to log by:</p>
<ol>
<li>creating a new Pod image <code>nginx:alpine</code></li>
<li><code>kubectl exec pod -- sh</code> into it</li>
<li>check the Falco logs contain a related output</li>
</ol>
<h4 id="tip-v2">Tip</h4>
<p><code>service falco status</code></p>
<p><code>cat /var/log/syslog | grep falco</code></p>
<h4 id="solution-v2">Solution</h4>
<p><code>k run pod --image=nginx:alpine</code></p>
<p><code>k exec -it pod -- sh</code></p>
<p><code>exit</code></p>
<p><code>cat /var/log/syslog | grep falco | grep shell</code></p>
<h3 id="change-a-falco-rule">Change a Falco Rule</h3>
<p>Change the Falco <code>output</code> of rule “Terminal shell in container” to:</p>
<ul>
<li>include <code>NEW SHELL!!!</code> at the very beginning</li>
<li>include <code>user_id=%user.uid</code> at any position</li>
<li>include <code>repo=%container.image.repository</code> at any position</li>
</ul>
<p>Cause syslog output again by creating a shell in that Pod.<br>
Verify the syslogs contain the new data.</p>
<h4 id="tip-v3">Tip</h4>
<p><a href="https://falco.org/docs/rules/supported-fields" target="_blank" rel="noopener">https://falco.org/docs/rules/supported-fields</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /etc/falco/</span><br><span class="line">grep -ri <span class="string">"shell in"</span></span><br></pre></td></tr></table></figure>
<h4 id="solution-v3">Solution</h4>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /etc/falco/</span><br><span class="line">cp falco_rules.yaml falco_rules.local.yaml</span><br><span class="line">vim falco_rules.local.yaml</span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">rule:</span> <span class="string">Terminal</span> <span class="string">shell</span> <span class="string">in</span> <span class="string">container</span></span><br><span class="line">  <span class="attr">desc:</span> <span class="string">A</span> <span class="string">shell</span> <span class="string">was</span> <span class="string">used</span> <span class="string">as</span> <span class="string">the</span> <span class="string">entrypoint/exec</span> <span class="string">point</span> <span class="string">into</span> <span class="string">a</span> <span class="string">container</span> <span class="string">with</span> <span class="string">an</span> <span class="string">attached</span> <span class="string">terminal.</span></span><br><span class="line">  <span class="attr">condition:</span> <span class="string">&gt;</span></span><br><span class="line">    <span class="string">spawned_process</span> <span class="string">and</span> <span class="string">container</span></span><br><span class="line">    <span class="string">and</span> <span class="string">shell_procs</span> <span class="string">and</span> <span class="string">proc.tty</span> <span class="string">!=</span> <span class="number">0</span></span><br><span class="line">    <span class="string">and</span> <span class="string">container_entrypoint</span></span><br><span class="line">    <span class="string">and</span> <span class="string">not</span> <span class="string">user_expected_terminal_shell_in_container_conditions</span></span><br><span class="line">  <span class="attr">output:</span> <span class="string">&gt;</span></span><br><span class="line">    <span class="string">NEW</span> <span class="string">SHELL!!!</span> <span class="string">(user_id=%user.uid</span> <span class="string">repo=%container.image.repository</span> <span class="string">%user.uiduser=%user.name</span> <span class="string">user_loginuid=%user.loginuid</span> <span class="string">%container.info</span></span><br><span class="line">    <span class="string">shell=%proc.name</span> <span class="string">parent=%proc.pname</span> <span class="string">cmdline=%proc.cmdline</span> <span class="string">terminal=%proc.tty</span> <span class="string">container_id=%container.id</span> <span class="string">image=%container.image.repository)</span></span><br><span class="line">  <span class="attr">priority:</span> <span class="string">NOTICE</span></span><br><span class="line">  <span class="attr">tags:</span> <span class="string">[container,</span> <span class="string">shell,</span> <span class="string">mitre_execution]</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">service falco restart</span><br><span class="line">k <span class="built_in">exec</span> -it pod -- sh</span><br><span class="line">cat /var/<span class="built_in">log</span>/syslog | grep falco | grep shell</span><br></pre></td></tr></table></figure>
<h2 id="networkpolicy-namespace-selector">NetworkPolicy - namespace selector</h2>
<p>There are existing Pods in Namespace <code>space1</code> and <code>space2</code> .</p>
<p>We need a new NetworkPolicy named <code>np</code> that restricts all Pods in Namespace <code>space1</code> to only have outgoing traffic to Pods in Namespace <code>space2</code> . Incoming traffic not affected.</p>
<p>We also need a new NetworkPolicy named <code>np</code> that restricts all Pods in Namespace <code>space2</code> to only have incoming traffic from Pods in Namespace <code>space1</code> . Outgoing traffic not affected.</p>
<p>The NetworkPolicies should still allow outgoing DNS traffic on port <code>53</code> TCP and UDP.</p>
<h3 id="tip-v4">Tip</h3>
<p>For learning you can check the NetworkPolicy Editor<br>
The namespaceSelector from NPs works with Namespace labels, so first we check existing labels for Namespaces</p>
<h3 id="solution-v4">Solution</h3>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 获取 namespace的label</span></span><br><span class="line">k get ns --show-labels</span><br><span class="line">  NAME              STATUS   AGE     LABELS</span><br><span class="line">  space1            Active   3m9s    kubernetes.io/metadata.name=space1</span><br><span class="line">  space2            Active   3m9s    kubernetes.io/metadata.name=space2</span><br><span class="line"></span><br><span class="line">vim 1.yaml</span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">NetworkPolicy</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">np</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">space1</span>  <span class="comment"># namespace 已经来表示应用到all Pods in Namespace `space1`</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">podSelector:</span> <span class="string">&#123;&#125;</span> <span class="comment"># 所有pod</span></span><br><span class="line">  <span class="attr">policyTypes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">Egress</span></span><br><span class="line">  <span class="attr">egress:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">to:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">namespaceSelector:</span></span><br><span class="line">          <span class="attr">matchLabels:</span></span><br><span class="line">            <span class="attr">kubernetes.io/metadata.name:</span> <span class="string">space2</span>  <span class="comment"># space2的namespace</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">ports:</span> <span class="comment"># 注意加 - 表示或的关系</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">        <span class="attr">port:</span> <span class="number">53</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">UDP</span></span><br><span class="line">        <span class="attr">port:</span> <span class="number">53</span></span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 2.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">NetworkPolicy</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">np</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">space2</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">podSelector:</span> <span class="string">&#123;&#125;</span></span><br><span class="line">  <span class="attr">policyTypes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">Ingress</span></span><br><span class="line">  <span class="attr">ingress:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">from:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">namespaceSelector:</span></span><br><span class="line">          <span class="attr">matchLabels:</span></span><br><span class="line">            <span class="attr">kubernetes.io/metadata.name:</span> <span class="string">space1</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">        <span class="attr">port:</span> <span class="number">53</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">UDP</span></span><br><span class="line">        <span class="attr">port:</span> <span class="number">53</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">k apply -f 1.yaml</span><br><span class="line">k apply -f 2.yaml</span><br></pre></td></tr></table></figure>
<h2 id="networkpolicy-metadata-protection">NetworkPolicy - Metadata Protection</h2>
<p><a href="https://killercoda.com/killer-shell-cks/scenario/networkpolicy-metadata-protection" target="_blank" rel="noopener">https://killercoda.com/killer-shell-cks/scenario/networkpolicy-metadata-protection</a></p>
<p>Cloud providers can have Metadata Servers which expose critical information, for example GCP or AWS.</p>
<p>For this task we assume that there is a Metadata Server at <code>1.1.1.1</code> .</p>
<p>You can test connection to that IP using <code>nc -v 1.1.1.1 53</code> .</p>
<p>Create a NetworkPolicy named <code>metadata-server</code>In Namespace <code>default</code> which restricts all egress traffic to that IP.</p>
<p>The NetworkPolicy should only affect Pods with label <code>trust=nope</code>.</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">NetworkPolicy</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">metadata-server</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">podSelector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">trust:</span> <span class="string">nope</span></span><br><span class="line">  <span class="attr">policyTypes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">Egress</span></span><br><span class="line">  <span class="attr">egress:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">to:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">ipBlock:</span></span><br><span class="line">          <span class="attr">cidr:</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span><span class="string">/0</span>  <span class="comment"># all addresses 掩码为0，且0.0.0.0，代表所有地址</span></span><br><span class="line">          <span class="attr">except:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="number">1.1</span><span class="number">.1</span><span class="number">.1</span><span class="string">/32</span> <span class="comment">#</span></span><br></pre></td></tr></table></figure>
<h2 id="rbac-user">RBAC - user</h2>
<p><a href="https://killercoda.com/killer-shell-cks/scenario/rbac-user-permissions" target="_blank" rel="noopener">https://killercoda.com/killer-shell-cks/scenario/rbac-user-permissions</a></p>
<p>There is existing Namespace applications.</p>
<ul>
<li>User <code>smoke</code> should be allowed to <code>create</code> and <code>delete</code> Pods, Deployments and StatefulSets in Namespace <code>applications</code>.</li>
<li>User <code>smoke</code> should have <code>view</code> permissions (like the permissions of the default ClusterRole named <code>view</code> ) in all Namespaces but not in <code>kube-system</code> .</li>
<li>User <code>smoke</code> should be allowed to retrieve available Secret names in Namespace <code>applications</code>. Just the Secret names, no data.</li>
<li>Verify everything using <code>kubectl auth can-i</code> .</li>
</ul>
<h3 id="solution-v5">Solution</h3>
<p>⁣1) RBAC for Namespace applications</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">k -n applications create role smoke --verb create,delete --resource pods,deployments,sts</span><br><span class="line">k -n applications create rolebinding smoke --role smoke --user smoke</span><br></pre></td></tr></table></figure>
<p>⁣2) view permission in all Namespaces but not kube-system</p>
<p>As of now it’s not possible to create deny-RBAC in K8s</p>
<p>So we allow for all other Namespaces</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">k get ns <span class="comment"># get all namespaces</span></span><br><span class="line">k -n applications create rolebinding smoke-view --clusterrole view --user smoke</span><br><span class="line">k -n default create rolebinding smoke-view --clusterrole view --user smoke</span><br><span class="line">k -n kube-node-lease create rolebinding smoke-view --clusterrole view --user smoke</span><br><span class="line">k -n kube-public create rolebinding smoke-view --clusterrole view --user smoke</span><br></pre></td></tr></table></figure>
<p>⁣3) just list Secret names, no content</p>
<p>This is NOT POSSIBLE using plain K8s RBAC. You might think of doing this:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># NOT POSSIBLE: assigning "list" also allows user to read secret values</span></span><br><span class="line">k -n applications create role list-secrets --verb list --resource secrets</span><br><span class="line"></span><br><span class="line">k -n applications create rolebinding ...</span><br></pre></td></tr></table></figure>
<p>Having the list verb you can simply run kubectl get secrets -oyaml and see all content. Dangerous misconfiguration!</p>
<h3 id="verify">Verify</h3>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># applications</span></span><br><span class="line">k auth can-i create deployments --as smoke -n applications <span class="comment"># YES</span></span><br><span class="line">k auth can-i delete deployments --as smoke -n applications <span class="comment"># YES</span></span><br><span class="line">k auth can-i delete pods --as smoke -n applications <span class="comment"># YES</span></span><br><span class="line">k auth can-i delete sts --as smoke -n applications <span class="comment"># YES</span></span><br><span class="line">k auth can-i delete secrets --as smoke -n applications <span class="comment"># NO</span></span><br><span class="line">k auth can-i list deployments --as smoke -n applications <span class="comment"># YES</span></span><br><span class="line">k auth can-i list secrets --as smoke -n applications <span class="comment"># NO</span></span><br><span class="line">k auth can-i get secrets --as smoke -n applications <span class="comment"># NO</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># view in all namespaces but not kube-system</span></span><br><span class="line">k auth can-i list pods --as smoke -n default <span class="comment"># YES</span></span><br><span class="line">k auth can-i list pods --as smoke -n applications <span class="comment"># YES</span></span><br><span class="line">k auth can-i list pods --as smoke -n kube-public <span class="comment"># YES</span></span><br><span class="line">k auth can-i list pods --as smoke -n kube-node-lease <span class="comment"># YES</span></span><br><span class="line">k auth can-i list pods --as smoke -n kube-system <span class="comment"># NO</span></span><br></pre></td></tr></table></figure>
<h2 id="rbac-serviceaccount">RBAC - ServiceAccount</h2>
<p>There are existing Namespaces <code>ns1</code> and <code>ns2</code><br>
Create ServiceAccount <code>pipeline</code> in both Namespaces.</p>
<ul>
<li>These SAs should be allowed to <code>view</code> almost everything in the whole cluster. You can use the default ClusterRole <code>view</code> for this</li>
<li>These SAs should be allowed to <code>create</code> and <code>delete</code> <code>Deployments</code> in their Namespace.</li>
</ul>
<p>Verify everything using <code>kubectl auth can-i</code></p>
<h3 id="solution-v6">Solution</h3>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># create Namespaces</span></span><br><span class="line">k -n ns1 create sa pipeline</span><br><span class="line">k -n ns2 create sa pipeline</span><br><span class="line"></span><br><span class="line"><span class="comment"># use ClusterRole view</span></span><br><span class="line">k get clusterrole view <span class="comment"># there is default one</span></span><br><span class="line">k create clusterrolebinding pipeline-view --clusterrole view --serviceaccount ns1:pipeline --serviceaccount ns2:pipeline</span><br><span class="line"></span><br><span class="line"><span class="comment"># manage Deployments in both Namespaces</span></span><br><span class="line">k create clusterrole -h <span class="comment"># examples</span></span><br><span class="line">k create clusterrole pipeline-deployment-manager --verb create,delete --resource deployments</span><br><span class="line"><span class="comment"># instead of one ClusterRole we could also create the same Role in both Namespaces</span></span><br><span class="line"></span><br><span class="line">k -n ns1 create rolebinding pipeline-deployment-manager --clusterrole pipeline-deployment-manager --serviceaccount ns1:pipeline</span><br><span class="line">k -n ns2 create rolebinding pipeline-deployment-manager --clusterrole pipeline-deployment-manager --serviceaccount ns2:pipeline</span><br></pre></td></tr></table></figure>
<h2 id="secret-etcd-encryption">Secret - ETCD Encryption</h2>
<p><a href="https://kubernetes.io/zh-cn/docs/tasks/administer-cluster/encrypt-data/" target="_blank" rel="noopener">https://kubernetes.io/zh-cn/docs/tasks/administer-cluster/encrypt-data/</a><br>
<a href="https://killercoda.com/killer-shell-cks/scenario/secret-etcd-encryption" target="_blank" rel="noopener">https://killercoda.com/killer-shell-cks/scenario/secret-etcd-encryption</a></p>
<h3 id="enable-etcd-encryption">Enable ETCD Encryption</h3>
<p>Create an <code>EncryptionConfiguration</code> file at <code>/etc/kubernetes/etcd/ec.yaml</code> and make ETCD use it.</p>
<ul>
<li>One provider should be of type <code>aesgcm</code> with password <code>this-is-very-sec</code> . All new secrets should be encrypted using this one.</li>
<li>One provider should be the <code>identity</code> one to still be able to read existing unencrypted secrets.</li>
</ul>
<h4 id="solution-v7">Solution</h4>
<p>Generate EncryptionConfiguration:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /etc/kubernetes/etcd</span><br><span class="line"><span class="built_in">echo</span> -n this-is-very-sec | base64</span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apiserver.config.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">EncryptionConfiguration</span></span><br><span class="line"><span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">resources:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">secrets</span></span><br><span class="line">    <span class="attr">providers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">aesgcm:</span></span><br><span class="line">        <span class="attr">keys:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">key1</span></span><br><span class="line">          <span class="attr">secret:</span> <span class="string">dGhpcy1pcy12ZXJ5LXNlYw==</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">identity:</span> <span class="string">&#123;&#125;</span></span><br></pre></td></tr></table></figure>
<ol>
<li>
<p>Add a new volume and volumeMount in <code>/etc/kubernetes/manifests/kube-apiserver.yaml</code>, so that the container can access the file.</p>
</li>
<li>
<p>Pass the new file as argument: <code>--encryption-provider-config=/etc/kubernetes/etcd/ec.yaml</code></p>
</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">command:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">kube-apiserver</span></span><br><span class="line"><span class="string">...</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--encryption-provider-config=/etc/kubernetes/etcd/ec.yaml</span></span><br><span class="line"><span class="string">...</span></span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/etc/kubernetes/etcd</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">etcd</span></span><br><span class="line">      <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line"><span class="string">...</span></span><br><span class="line">  <span class="attr">hostNetwork:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">priorityClassName:</span> <span class="string">system-cluster-critical</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">hostPath:</span></span><br><span class="line">      <span class="attr">path:</span> <span class="string">/etc/kubernetes/etcd</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">DirectoryOrCreate</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">etcd</span></span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></table></figure>
<p>Wait till apiserver was restarted: <code>watch crictl ps</code></p>
<h3 id="encrypt-existing-secrets">Encrypt existing Secrets</h3>
<p>Encrypt all existing Secrets in Namespace <code>one</code> using the new provider<br>
Encrypt all existing Secrets in Namespace <code>two</code> using the new provider<br>
Encrypt all existing Secrets in Namespace <code>three</code> using the new provider</p>
<h4 id="tip-v5">Tip</h4>
<p>Recreate Secrets so they are encrypted through the new encryption settings.</p>
<h4 id="solution-v8">Solution</h4>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n one get secrets -o json | kubectl replace -f -</span><br><span class="line">kubectl -n two get secrets -o json | kubectl replace -f -</span><br><span class="line">kubectl -n three get secrets -o json | kubectl replace -f -</span><br></pre></td></tr></table></figure>
<p>To check you can do for example:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ETCDCTL_API=3 etcdctl --cert /etc/kubernetes/pki/apiserver-etcd-client.crt --key /etc/kubernetes/pki/apiserver-etcd-client.key --cacert /etc/kubernetes/pki/etcd/ca.crt get /registry/secrets/one/s1</span><br></pre></td></tr></table></figure>
<p>The output should be encrypted and prefixed with <code>k8s:enc:aesgcm:v1:key1</code>.</p>
<h2 id="secret-read-and-decode">Secret - Read and Decode</h2>
<h3 id="read-and-decode-the-secrets-in-namespace-one">Read and decode the Secrets in Namespace one</h3>
<ol>
<li>Get the Secrets of type Opaque that have been created in Namespace one .</li>
<li>Create a new file called /opt/ks/one and store the base64-decoded values in that file. Each value needs to be stored on a new line.</li>
</ol>
<h4 id="solution-v9">Solution</h4>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">k get secrets -n one</span><br><span class="line">NAME   TYPE     DATA   AGE</span><br><span class="line">s1     Opaque   1      39s</span><br><span class="line">s2     Opaque   1      39s</span><br><span class="line"></span><br><span class="line">k get secrets s1 -n one -o yaml | grep data: -A 3</span><br><span class="line">data:</span><br><span class="line">  data: c2VjcmV0</span><br><span class="line">kind: Secret</span><br><span class="line"></span><br><span class="line">k get secrets s2 -n one -o yaml | grep data: -A 3</span><br><span class="line">data:</span><br><span class="line">  data: YWRtaW4=</span><br><span class="line">kind: Secret</span><br><span class="line"></span><br><span class="line">kubectl -n one get secret s1 -ojsonpath=<span class="string">"&#123;.data.data&#125;"</span> | base64 -d</span><br><span class="line"></span><br><span class="line">kubectl -n one get secret s2 -ojsonpath=<span class="string">"&#123;.data.data&#125;"</span> | base64 -d</span><br><span class="line"></span><br><span class="line">vim /opt/ks/one</span><br></pre></td></tr></table></figure>
<p>Your file <code>/opt/ks/one</code> should look like this:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">secret</span></span><br><span class="line"><span class="string">admin</span></span><br></pre></td></tr></table></figure>
<h2 id="privilege-escalation-containers">Privilege Escalation Containers</h2>
<p>Set Privilege Escalation for Deployment</p>
<p>There is a Deployment named <code>logger</code> which constantly outputs the <code>NoNewPrivs</code> flag.</p>
<p>Let the Pods of that Deployment run with <code>Privilege Escalation</code> disabled.</p>
<p>The logs should show the field change.</p>
<h3 id="solution-v10">Solution</h3>
<p>Check them logs <code>k logs -f deploy/logger</code></p>
<p>Edit the Deployment and set the <code>allowPrivilegeEscalation</code> field:</p>
<p><code>k edit deployments.apps logger</code></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">...</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">logger</span></span><br><span class="line">  <span class="attr">strategy:</span> <span class="string">&#123;&#125;</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">logger</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">httpd:2.4.52-alpine</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">httpd</span></span><br><span class="line">        <span class="attr">securityContext:</span></span><br><span class="line">            <span class="attr">allowPrivilegeEscalation:</span> <span class="literal">false</span>  <span class="comment"># 注意加在containers下面，而非spec下</span></span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></table></figure>
<h2 id="privileged-containers">Privileged Containers</h2>
<p><a href="https://killercoda.com/killer-shell-cks/scenario/privileged-containers" target="_blank" rel="noopener">https://killercoda.com/killer-shell-cks/scenario/privileged-containers</a></p>
<h3 id="create-a-privileged-pod">Create a privileged Pod</h3>
<ul>
<li>Create a Pod named <code>prime</code> image <code>nginx:alpine</code> .</li>
<li>The container should run as <code>privileged</code> .</li>
</ul>
<p>Install iptables (<code>apk add iptables</code> ) inside the Pod.</p>
<p>Test the capabilities using <code>iptables -L</code> .</p>
<h4 id="solution-v11">Solution</h4>
<p>Generate Pod yaml<br>
<code>k run prime --image=nginx:alpine -oyaml --dry-run=client --command -- sh -c 'sleep 1d' &gt; pod.yaml</code></p>
<p>Set the privileged :</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">run:</span> <span class="string">prime</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">prime</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">command:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">sh</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">-c</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">sleep</span> <span class="string">1d</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx:alpine</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">prime</span></span><br><span class="line">    <span class="attr">securityContext:</span></span><br><span class="line">      <span class="attr">privileged:</span> <span class="literal">true</span>      <span class="comment"># Add, 注意加在containers下面，而非spec下</span></span><br><span class="line">  <span class="attr">dnsPolicy:</span> <span class="string">ClusterFirst</span></span><br><span class="line">  <span class="attr">restartPolicy:</span> <span class="string">Always</span></span><br></pre></td></tr></table></figure>
<p>Now exec into the Pod and run apk add iptables .</p>
<p><code>k exec prime -- apk add iptables</code></p>
<p>You’ll see that iptables -L needs capabilities to run which it here gets through privileged.</p>
<p><code>k exec prime -- iptables -L</code></p>
<h3 id="create-a-privileged-statefulset">Create a privileged StatefulSet</h3>
<p>There is an existing StatefulSet yaml at <code>/application/sts.yaml</code> .</p>
<p>It should run as <code>privileged</code> but it seems like it cannot be applied.</p>
<p>Fix it and create the StatefulSet.</p>
<h4 id="solution-v12">Solution</h4>
<p>Edit the yaml to set privileged in the container section:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StatefulSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">habanero</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">habanero</span></span><br><span class="line">  <span class="attr">serviceName:</span> <span class="string">habanero</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">habanero</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="comment">#securityContext:                   # remove</span></span><br><span class="line">        <span class="comment">#privileged: true                 # remove</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">habanero</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">nginx:alpine</span></span><br><span class="line">          <span class="attr">command:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">sh</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">-c</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">apk</span> <span class="string">add</span> <span class="string">iptables</span> <span class="string">&amp;&amp;</span> <span class="string">sleep</span> <span class="string">1d</span></span><br><span class="line">          <span class="attr">securityContext:</span>                <span class="comment"># add</span></span><br><span class="line">            <span class="attr">privileged:</span> <span class="literal">true</span>              <span class="comment"># add</span></span><br></pre></td></tr></table></figure>
<h2 id="container-hardening">Container Hardening</h2>
<p>Harden a given Docker Container<br>
There is a Dockerfile at <code>/root/image/Dockerfile</code> .</p>
<p>It’s a simple container which tries to make a curl call to an imaginary api with a secret token, the call will 404 , but that’s okay.</p>
<ol>
<li>Use specific version <code>20.04</code> for the base image</li>
<li>Remove layer caching issues with <code>apt-get</code></li>
<li>Remove the hardcoded secret value <code>2e064aad-3a90–4cde-ad86–16fad1f8943e</code>. The secret value should be passed into the container during runtime as env variable <code>TOKEN</code></li>
<li>Make it impossible to <code>docker exec</code> , <code>podman exec</code> or <code>kubectl exec</code> into the container using <code>bash</code><br>
You can build the image using</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /root/image</span><br><span class="line">docker build .</span><br></pre></td></tr></table></figure>
<h3 id="solution-v13">Solution</h3>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># vim /root/image/Dockerfile</span></span><br><span class="line">FROM ubuntu</span><br><span class="line">RUN apt-get update </span><br><span class="line">RUN apt-get -y install curl</span><br><span class="line">ENV URL https://google.com/this-will-fail?secret-token=</span><br><span class="line">CMD [<span class="string">"sh"</span>, <span class="string">"-c"</span>, <span class="string">"curl --head <span class="variable">$URL</span>=2e064aad-3a90-4cde-ad86-16fad1f8943e"</span>]</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 修改为</span></span><br><span class="line">FROM ubuntu:20.04  <span class="comment"># 1 Specific version</span></span><br><span class="line">RUN apt-get update &amp;&amp; apt-get -y install curl <span class="comment"># 2 Remove Layer Caching</span></span><br><span class="line">ENV URL https://google.com/this-will-fail?secret-token=</span><br><span class="line">RUN rm /usr/bin/bash <span class="comment"># 4 remove bash</span></span><br><span class="line">CMD [<span class="string">"sh"</span>, <span class="string">"-c"</span>, <span class="string">"curl --head <span class="variable">$URL</span><span class="variable">$TOKEN</span>"</span>] <span class="comment"># 3 Secret as runtime Env variable</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /root/image</span><br><span class="line">docker build .</span><br><span class="line">docker image ls</span><br><span class="line"></span><br><span class="line"><span class="comment"># 或者</span></span><br><span class="line">podman build -t app .</span><br><span class="line">podman image ls</span><br><span class="line">    REPOSITORY                TAG         IMAGE ID      CREATED         SIZE</span><br><span class="line">    localhost/app             latest      2bb9ee2ae5bc  57 seconds ago  132 MB</span><br><span class="line"></span><br><span class="line">podman run -d -e TOKEN=2e064aad-3a90-4cde-ad86-16fad1f8943e app sleep 1d <span class="comment"># run in background</span></span><br><span class="line">podman ps | grep app</span><br><span class="line">    CONTAINER ID  IMAGE                 COMMAND     CREATED        STATUS            PORTS       NAMES</span><br><span class="line">    4a848daec2e2  localhost/app:latest  sleep 1d    9 seconds ago  Up 9 seconds ago              heuristic_golick</span><br><span class="line"></span><br><span class="line">podman <span class="built_in">exec</span> -it 4a848daec2e2 bash <span class="comment"># fails</span></span><br><span class="line">podman <span class="built_in">exec</span> -it 4a848daec2e2 sh <span class="comment"># works</span></span><br></pre></td></tr></table></figure>
<h2 id="container-image-footprint-user">Container Image Footprint User</h2>
<h3 id="run-the-default-dockerfile">Run the default Dockerfile</h3>
<p>There is a given Dockerfile under /opt/ks/Dockerfile .</p>
<p>Using Docker:</p>
<ul>
<li>Build an image named <code>base-image</code> from the Dockerfile.</li>
<li>Run a container named <code>c1</code> from that image.</li>
<li>Check under which user the sleep process is running inside the container</li>
</ul>
<h4 id="solution-v14">Solution</h4>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Build and run</span></span><br><span class="line"><span class="built_in">cd</span> /opt/ks/</span><br><span class="line">docker build -t base-image .</span><br><span class="line">docker run --name c1 -d base-image</span><br><span class="line"></span><br><span class="line"><span class="comment"># Show the user of processes</span></span><br><span class="line">docker <span class="built_in">exec</span> c1 ps</span><br><span class="line">    PID   USER     TIME  COMMAND</span><br><span class="line">        1 root      0:00 sleep 1d</span><br><span class="line">        2 root      0:00 ps</span><br><span class="line"><span class="comment"># (to start again) Delete container</span></span><br><span class="line">docker rm c1 --force</span><br></pre></td></tr></table></figure>
<h3 id="run-container-as-user">Run container as user</h3>
<p>Modify the Dockerfile <code>/opt/ks/Dockerfile</code> to run processes as user <code>appuser</code><br>
Update the image <code>base-image</code> with your change<br>
Build a new container <code>c2</code> from that image</p>
<h4 id="solution-v15">Solution</h4>
<p>Add the USER docker command:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">FROM alpine:3.12.3</span><br><span class="line">RUN adduser -D -g <span class="string">''</span> appuser</span><br><span class="line">USER appuser <span class="comment"># Add this line</span></span><br><span class="line">CMD sh -c <span class="string">'sleep 1d'</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Build and run:</span></span><br><span class="line"><span class="built_in">cd</span> /opt/ks/</span><br><span class="line">docker build -t base-image .</span><br><span class="line">docker run --name c2 -d base-image</span><br><span class="line"></span><br><span class="line"><span class="comment"># Show the user of processes</span></span><br><span class="line">docker <span class="built_in">exec</span> c2 ps</span><br><span class="line"></span><br><span class="line"><span class="comment"># (to start again) Delete container</span></span><br><span class="line">docker rm c2 --force</span><br></pre></td></tr></table></figure>
<h2 id="runtimeclass-gvisor">RuntimeClass - gVisor</h2>
<p><a href="https://killercoda.com/killer-shell-cks/scenario/sandbox-gvisor" target="_blank" rel="noopener">https://killercoda.com/killer-shell-cks/scenario/sandbox-gvisor</a></p>
<h3 id="install-and-configure-gvisor">Install and configure gVisor</h3>
<p>You should install gVisor on the node <code>node01</code> and make containerd use it.<br>
There is install script <code>/root/gvisor-install.sh</code> which should setup everything, execute it on node <code>node01</code> .</p>
<h4 id="solution-v16"><strong>Solution</strong></h4>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">scp gvisor-install.sh node01:/root</span><br><span class="line">ssh node01</span><br><span class="line">    sh gvisor-install.sh</span><br><span class="line">    service kubelet status</span><br></pre></td></tr></table></figure>
<h3 id="create-runtimeclass-and-pod-to-use-gvisor">Create RuntimeClass and Pod to use gVisor</h3>
<p>Now that gVisor should be configured, create a new <code>RuntimeClass</code> for it.<br>
Then create a new Pod named <code>sec</code> using image <code>nginx:1.21.5-alpine</code> .<br>
Verify your setup by running <code>dmesg</code> in the Pod.</p>
<h4 id="tip-v6">Tip</h4>
<p>The handler for the gVisor RuntimeClass is <code>runsc</code>.</p>
<h4 id="solution-v17">Solution</h4>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Back to cantroplane</span></span><br><span class="line">node01 $ <span class="built_in">exit</span></span><br><span class="line">    <span class="built_in">logout</span></span><br><span class="line">    Connection to node01 closed.</span><br><span class="line">controlplane $</span><br></pre></td></tr></table></figure>
<p>First we create the RuntimeClass</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">node.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">RuntimeClass</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">gvisor</span></span><br><span class="line"><span class="attr">handler:</span> <span class="string">runsc</span></span><br></pre></td></tr></table></figure>
<p>And the Pod that uses it</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">sec</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">runtimeClassName:</span> <span class="string">gvisor</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">nginx:1.21.5-alpine</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">sec</span></span><br><span class="line">  <span class="attr">dnsPolicy:</span> <span class="string">ClusterFirst</span></span><br><span class="line">  <span class="attr">restartPolicy:</span> <span class="string">Always</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">k apply -f rc.yaml</span><br><span class="line">k apply -f pod.yaml</span><br></pre></td></tr></table></figure>
<h4 id="verify-v2">Verify</h4>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">k <span class="built_in">exec</span> sec -- dmesg | grep -i gvisor</span><br></pre></td></tr></table></figure>
<h2 id="certificatesigningrequests-sign-manually">CertificateSigningRequests sign manually</h2>
<p><a href="https://killercoda.com/killer-shell-cks/scenario/certificate-signing-requests-sign-manually" target="_blank" rel="noopener">https://killercoda.com/killer-shell-cks/scenario/certificate-signing-requests-sign-manually</a></p>
<p><a href="https://kubernetes.io/zh-cn/docs/reference/access-authn-authz/certificate-signing-requests/#create-private-key" target="_blank" rel="noopener">https://kubernetes.io/zh-cn/docs/reference/access-authn-authz/certificate-signing-requests/#create-private-key</a></p>
<h3 id="create-key-and-csr">Create KEY and CSR</h3>
<p>The idea here is to create a new “user” that can communicate with K8s.</p>
<p>For this now:</p>
<ol>
<li>Create a new KEY at /root/60099.key for user named 60099@internal.users</li>
<li>Create a CSR at /root/60099.csr for the KEY</li>
</ol>
<h4 id="explanation">Explanation</h4>
<p>Users in K8s are managed via CRTs and the CN/CommonName field in them. The cluster CA needs to sign these CRTs.</p>
<p>This can be achieved with the following procedure:</p>
<ul>
<li>Create a KEY (Private Key) file</li>
<li>Create a CSR (CertificateSigningRequest) file for that KEY</li>
<li>Create a CRT (Certificate) by signing the CSR. Done using the CA (Certificate Authority) of the cluster</li>
</ul>
<h4 id="tip-v7">Tip</h4>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">openssl genrsa -out XXX 2048</span><br><span class="line">openssl req -new -key XXX -out XXX</span><br></pre></td></tr></table></figure>
<h4 id="solution-v18">Solution</h4>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">openssl genrsa -out 60099.key 2048</span><br><span class="line">openssl req -new -key 60099.key -out 60099.csr</span><br><span class="line"><span class="comment"># set Common Name = 60099@internal.users</span></span><br></pre></td></tr></table></figure>
<h3 id="manual-signing">Manual signing</h3>
<p>Manually sign the CSR with the K8s CA file to generate the CRT at /root/60099.crt .</p>
<p>Create a new context for kubectl named 60099@internal.users which uses this CRT to connect to K8s.</p>
<h4 id="tip-1">Tip 1</h4>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl x509 -req -<span class="keyword">in</span> XXX -CA XXX -CAkey XXX -CAcreateserial -out XXX -days 500</span><br></pre></td></tr></table></figure>
<h4 id="tip-2">Tip 2</h4>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find /etc/kubernetes/pki | grep ca</span><br></pre></td></tr></table></figure>
<h4 id="solution-1-v2">Solution 1</h4>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl x509 -req -<span class="keyword">in</span> 60099.csr -CA /etc/kubernetes/pki/ca.crt -CAkey /etc/kubernetes/pki/ca.key -CAcreateserial -out 60099.crt -days 500</span><br></pre></td></tr></table></figure>
<h4 id="solution-2-v2">Solution 2</h4>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">k config <span class="built_in">set</span>-credentials 60099@internal.users --client-key=60099.key --client-certificate=60099.crt</span><br><span class="line">k config <span class="built_in">set</span>-context 60099@internal.users --cluster=kubernetes --user=60099@internal.users</span><br><span class="line">k config get-contexts</span><br><span class="line">k config use-context 60099@internal.users</span><br><span class="line">k get ns <span class="comment"># fails because no permissions, but shows the correct username returne</span></span><br></pre></td></tr></table></figure>
<h2 id="certificatesigningrequests-sign-via-api">CertificateSigningRequests sign via API</h2>
<p><a href="https://killercoda.com/killer-shell-cks/scenario/certificate-signing-requests-sign-k8s" target="_blank" rel="noopener">https://killercoda.com/killer-shell-cks/scenario/certificate-signing-requests-sign-k8s</a></p>
<p><a href="https://kubernetes.io/zh-cn/docs/reference/access-authn-authz/certificate-signing-requests/#create-private-key" target="_blank" rel="noopener">https://kubernetes.io/zh-cn/docs/reference/access-authn-authz/certificate-signing-requests/#create-private-key</a></p>
<h3 id="create-key-and-csr-v2">Create KEY and CSR</h3>
<p>The idea here is to create a new “user” that can communicate with K8s.<br>
For this now:</p>
<ol>
<li>Create a new KEY at /root/60099.key for user named 60099@internal.users</li>
<li>Create a CSR at /root/60099.csr for the KEY</li>
</ol>
<h4 id="tip-v8">Tip</h4>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">openssl genrsa -out XXX 2048</span><br><span class="line"></span><br><span class="line">openssl req -new -key XXX -out XXX</span><br></pre></td></tr></table></figure>
<h4 id="solution-v19">Solution</h4>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">openssl genrsa -out 60099.key 2048</span><br><span class="line"></span><br><span class="line">openssl req -new -key 60099.key -out 60099.csr</span><br><span class="line"><span class="comment"># set Common Name = 60099@internal.users</span></span><br></pre></td></tr></table></figure>
<h3 id="signing-via-api">Signing via API</h3>
<p>Create a K8s CertificateSigningRequest resource named <code>60099@internal.users</code> and which sends the <code>/root/60099.csr</code> to the API.<br>
Let the K8s API sign the CertificateSigningRequest.<br>
Download the CRT file to <code>/root/60099.crt</code> .</p>
<p>Create a new context for kubectl named <code>60099@internal.users</code> which uses this CRT to connect to K8s.</p>
<h4 id="certificatesigningrequest-template">CertificateSigningRequest template</h4>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: certificates.k8s.io/v1</span><br><span class="line">kind: CertificateSigningRequest</span><br><span class="line">metadata:</span><br><span class="line">  name: 60099@internal.users <span class="comment"># ADD</span></span><br><span class="line">spec:</span><br><span class="line">  groups:</span><br><span class="line">  - system:authenticated</span><br><span class="line">  request: &#123;&#123;BASE_64_ENCODED_CSR&#125;&#125; <span class="comment"># ADD</span></span><br><span class="line">  signerName: kubernetes.io/kube-apiserver-client</span><br><span class="line">  usages:</span><br><span class="line">  - client auth</span><br></pre></td></tr></table></figure>
<h4 id="solution-v20">Solution</h4>
<p>Convert the CSR file into base64</p>
<p><code>cat 60099.csr | base64 -w 0</code></p>
<p>Copy it into the YAML</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">certificates.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">CertificateSigningRequest</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="number">60099</span><span class="string">@internal.users</span> <span class="comment"># ADD</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">groups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">system:authenticated</span></span><br><span class="line">  <span class="attr">request:</span> <span class="string">LS0tLS1CRUdJTiBDRVJUSUZJQ0FURSBSRVFV...</span> <span class="comment"># ADD</span></span><br><span class="line">  <span class="attr">signerName:</span> <span class="string">kubernetes.io/kube-apiserver-client</span></span><br><span class="line">  <span class="attr">usages:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">client</span> <span class="string">auth</span></span><br></pre></td></tr></table></figure>
<p>Create and approve</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">k -f csr.yaml create</span><br><span class="line">k get csr <span class="comment"># pending</span></span><br><span class="line">k certificate approve 60099@internal.users</span><br><span class="line">k get csr <span class="comment"># approved</span></span><br><span class="line">k get csr 60099@internal.users -ojsonpath=<span class="string">"&#123;.status.certificate&#125;"</span> | base64 -d &gt; 60099.crt</span><br></pre></td></tr></table></figure>
<h4 id="use-the-crt">Use the CRT</h4>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">k config <span class="built_in">set</span>-credentials 60099@internal.users --client-key=60099.key --client-certificate=60099.crt</span><br><span class="line">k config <span class="built_in">set</span>-context 60099@internal.users --cluster=kubernetes --user=60099@internal.users</span><br><span class="line">k config get-contexts</span><br><span class="line">k config use-context 60099@internal.users</span><br><span class="line">k get ns <span class="comment"># fails because no permissions, but shows the correct username returned</span></span><br></pre></td></tr></table></figure>
<h2 id="image-use-digest">Image Use Digest</h2>
<h3 id="use-an-image-digest-instead-of-tag">Use an image digest instead of tag</h3>
<p>Image tags can be overwritten, digests not.</p>
<p>Create a Pod named <code>crazy-pod</code> which uses the image digest <code>nginx@sha256:eb05700fe7baa6890b74278e39b66b2ed1326831f9ec3ed4bdc6361a4ac2f333</code> .</p>
<h4 id="solution-v21">Solution</h4>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Simply use the image@sha256:digest as image:</span></span><br><span class="line">k run crazy-pod --image=nginx@sha256:eb05700fe7baa6890b74278e39b66b2ed1326831f9ec3ed4bdc6361a4ac2f333</span><br></pre></td></tr></table></figure>
<h3 id="switch-deployment-from-using-tag-to-digest">Switch deployment from using tag to digest</h3>
<p>Convert the existing Deployment <code>crazy-deployment</code> to use the image digest of the current tag instead of the tag.</p>
<h4 id="solution-v22">Solution</h4>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># get digest</span></span><br><span class="line">k get deploy --show-labels</span><br><span class="line">k get pod -l app=crazy-deployment -oyaml | grep imageID</span><br><span class="line"></span><br><span class="line"><span class="comment"># use digest</span></span><br><span class="line">k edit deploy crazy-deployment <span class="comment"># image: httpd@sha256:c7b8040505e2e63eafc82d37148b687ff488bf6d25fc24c8bf01d71f5b457531</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># control</span></span><br><span class="line">k get pod -l app=crazy-deployment -oyaml | grep image:</span><br></pre></td></tr></table></figure>
<h2 id="securitycontext-immutability-readonly-filesystem">securityContext - Immutability Readonly Filesystem</h2>
<p><a href="https://killercoda.com/killer-shell-cks/scenario/immutability-readonly-fs" target="_blank" rel="noopener">https://killercoda.com/killer-shell-cks/scenario/immutability-readonly-fs</a></p>
<h3 id="create-a-pod-with-read-only-filesystem">Create a Pod with read-only filesystem</h3>
<p>Create a Pod named <code>pod-ro</code> in Namespace <code>sun</code> of image <code>busybox:1.32.0</code> .<br>
Make sure the container keeps running, like using <code>sleep 1d</code> .</p>
<p>The container root filesystem should be read-only.</p>
<h4 id="solution-v23">Solution</h4>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Generate Pod yaml</span></span><br><span class="line">k -n sun run pod-ro --image=busybox:1.32.0 -oyaml --dry-run=client --<span class="built_in">command</span> -- sh -c <span class="string">'sleep 1d'</span> &gt; pod.yaml</span><br></pre></td></tr></table></figure>
<p>Set the readOnlyRootFilesystem :</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">run:</span> <span class="string">pod-ro</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod-ro</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">sun</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">command:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">sh</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">-c</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">sleep</span> <span class="string">1d</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">busybox:1.32.0</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">pod-ro</span></span><br><span class="line">    <span class="attr">securityContext:</span></span><br><span class="line">      <span class="attr">readOnlyRootFilesystem:</span> <span class="literal">true</span>  <span class="comment"># Add</span></span><br><span class="line">  <span class="attr">dnsPolicy:</span> <span class="string">ClusterFirst</span></span><br><span class="line">  <span class="attr">restartPolicy:</span> <span class="string">Always</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">k apply -f pod.yaml</span><br></pre></td></tr></table></figure>
<h3 id="fix-existing-nginx-deployment-to-work-with-read-only-filesystem">Fix existing Nginx Deployment to work with read-only filesystem</h3>
<p>The Deployment <code>web4.0</code> in Namespace <code>moon</code> doesn’t seem to work with <code>readOnlyRootFilesystem</code> .</p>
<p>Add an emptyDir volume to fix this.</p>
<h4 id="solution-v24">Solution</h4>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Check the logs to find the location that needs to be writable</span><br><span class="line"></span><br><span class="line">k -n moon logs -f deploy/web4.0</span><br><span class="line">    Found 2 pods, using pod/web4.0-8554496f95-trtz9</span><br><span class="line">    sh: can<span class="string">'t create /etc/date.log: Read-only file system</span></span><br></pre></td></tr></table></figure>
<p>Edit the Deployment, add a new emptyDir volume</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">...</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">command:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">sh</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">-c</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">date</span> <span class="string">&gt;</span> <span class="string">/etc/date.log</span> <span class="string">&amp;&amp;</span> <span class="string">sleep</span> <span class="string">1d</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">busybox:1.32.0</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">container</span></span><br><span class="line">        <span class="attr">securityContext:</span></span><br><span class="line">          <span class="attr">readOnlyRootFilesystem:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/etc</span>  <span class="comment"># Get from log, the location that needs to be writable</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">temp</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">temp</span></span><br><span class="line">        <span class="attr">emptyDir:</span> <span class="string">&#123;&#125;</span></span><br></pre></td></tr></table></figure>
<h2 id="static-manual-analysis-k8s">Static Manual Analysis K8s</h2>
<h3 id="analyse-k8s-pod-yaml">Analyse K8s Pod YAML</h3>
<p>Perform a manual static analysis on files <code>/root/apps/app1-*</code> considering security.<br>
Move the less secure file to <code>/root/insecure</code></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># app1-30b5eba5.yaml </span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">main</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">alpine</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">["/bin/sleep",</span> <span class="string">"999999"</span><span class="string">]</span></span><br><span class="line">    <span class="attr">securityContext:</span></span><br><span class="line">      <span class="attr">readOnlyRootFilesystem:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">dnsPolicy:</span> <span class="string">ClusterFirst</span></span><br><span class="line">  <span class="attr">restartPolicy:</span> <span class="string">Always</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># app1-510d6362.yaml </span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">main</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">alpine</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">["/bin/sleep",</span> <span class="string">"999999"</span><span class="string">]</span></span><br><span class="line">    <span class="attr">livenessProbe:</span></span><br><span class="line">      <span class="attr">exec:</span></span><br><span class="line">        <span class="attr">command:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">cat</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">/tmp/healthy</span></span><br><span class="line">      <span class="attr">initialDelaySeconds:</span> <span class="number">5</span></span><br><span class="line">      <span class="attr">periodSeconds:</span> <span class="number">5</span></span><br></pre></td></tr></table></figure>
<h4 id="tip-v9">Tip</h4>
<p>Enforcing a read-only root filesystem can make containers more secure.</p>
<h4 id="solution-v25">Solution</h4>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /root/apps   </span><br><span class="line">ls</span><br><span class="line">    app1-30b5eba5.yaml  app1-510d6362.yaml  app2-b917e60e.yaml  app2-f720cbb4.yaml  app3-819f4686.yaml  app3-905fe637.yaml</span><br><span class="line"></span><br><span class="line">mv /root/apps/app1-510d6362.yaml /root/insecure</span><br></pre></td></tr></table></figure>
<h3 id="analyse-k8s-deployment-yaml">Analyse K8s Deployment YAML</h3>
<p>Perform a manual static analysis on files <code>/root/apps/app2-*</code> considering security.<br>
Move the less secure file to <code>/root/insecure</code></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># app2-b917e60e.yaml </span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">web</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">web</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">web</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">web</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">web</span></span><br><span class="line">        <span class="attr">securityContext:</span></span><br><span class="line">          <span class="attr">capabilities:</span></span><br><span class="line">            <span class="attr">drop:</span> <span class="string">[]</span></span><br><span class="line">          <span class="attr">allowPrivilegeEscalation:</span> <span class="literal">true</span>  <span class="comment"># not secure</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">httpd</span></span><br><span class="line">        <span class="attr">readinessProbe:</span></span><br><span class="line">          <span class="attr">exec:</span></span><br><span class="line">            <span class="attr">command:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">cat</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">/tmp/healthy</span></span><br><span class="line">          <span class="attr">initialDelaySeconds:</span> <span class="number">5</span></span><br><span class="line">          <span class="attr">periodSeconds:</span> <span class="number">5</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># app2-f720cbb4.yaml </span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-deployment</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">securityContext:</span></span><br><span class="line">        <span class="attr">runAsNonRoot:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">runAsUser:</span> <span class="number">10001</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">nginx:1.21.6</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>
<h4 id="tip-v10">Tip</h4>
<p>Check the <code>securityContext</code> settings, just because there are some doesn’t mean they do something good or at all.</p>
<h4 id="solution-v26">Solution</h4>
<p>File a<code>pp2-b917e60e.yaml</code> has some <code>securityContext</code> settings, but they don’t drop any capabilities and even allow <code>allowPrivilegeEscalation</code>.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mv /root/apps/app2-b917e60e.yaml /root/insecure</span><br></pre></td></tr></table></figure>
<h3 id="analyse-k8s-statefulset-yaml">Analyse K8s StatefulSet YAML</h3>
<p>Perform a manual static analysis on files <code>/root/apps/app3-*</code> considering security.<br>
Move the less secure file to <code>/root/insecure</code></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># app3-819f4686.yaml </span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">web</span></span><br><span class="line">  <span class="attr">clusterIP:</span> <span class="string">None</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StatefulSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">web</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">serviceName:</span> <span class="string">"nginx"</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">minReadySeconds:</span> <span class="number">10</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">terminationGracePeriodSeconds:</span> <span class="number">10</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">k8s.gcr.io/nginx-slim:0.8</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">web</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">www</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/usr/share/nginx/html</span></span><br><span class="line">        <span class="attr">readinessProbe:</span></span><br><span class="line">          <span class="attr">httpGet:</span></span><br><span class="line">            <span class="attr">scheme:</span> <span class="string">HTTPS</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/index.html</span></span><br><span class="line">            <span class="attr">port:</span> <span class="number">8443</span></span><br><span class="line">          <span class="attr">initialDelaySeconds:</span> <span class="number">10</span></span><br><span class="line">          <span class="attr">periodSeconds:</span> <span class="number">5</span></span><br><span class="line">        <span class="attr">startupProbe:</span></span><br><span class="line">          <span class="attr">httpGet:</span></span><br><span class="line">            <span class="attr">scheme:</span> <span class="string">HTTPS</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/index.html</span></span><br><span class="line">            <span class="attr">port:</span> <span class="number">8443</span></span><br><span class="line">          <span class="attr">initialDelaySeconds:</span> <span class="number">10</span></span><br><span class="line">          <span class="attr">periodSeconds:</span> <span class="number">5</span></span><br><span class="line">        <span class="attr">securityContext:</span></span><br><span class="line">          <span class="attr">privileged:</span> <span class="literal">true</span>  <span class="comment"># not secure</span></span><br><span class="line">        <span class="string">...</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># app3-905fe637.yaml </span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StatefulSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mysql-set</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">mysql</span></span><br><span class="line">  <span class="attr">serviceName:</span> <span class="string">"mysql"</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">mysql</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">terminationGracePeriodSeconds:</span> <span class="number">10</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mysql</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">mysql:5.7</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">3306</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mysql-store</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/var/lib/mysql</span></span><br><span class="line">        <span class="attr">securityContext:</span></span><br><span class="line">          <span class="attr">privileged:</span> <span class="literal">false</span>    <span class="comment"># secure</span></span><br><span class="line">        <span class="string">...</span></span><br></pre></td></tr></table></figure>
<h4 id="tip-v11">Tip</h4>
<p>If you face large files, search for settings like <code>securityContext</code> .</p>
<h4 id="solution-v27">Solution</h4>
<p>We see usage of privileged: true .</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cat /root/apps/app3-819f4686.yaml | grep securityContext -A 3</span><br><span class="line">mv /root/apps/app3-819f4686.yaml /root/insecure</span><br></pre></td></tr></table></figure>


                    <!-- Donate -->

<div>
    <div class="donate-container" style="padding: 10px 0; margin: auto auto; width: 90%; text-align: center;">
        <div></div>
        <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
        <span>Donate</span>
        </button>
        <div id="QR" style="display: none;">
            <div id="wechat" style="display: inline-block">
                <img id="wechat_qr" src="https://github.com/CatherineLiyuankun/PictureBed/raw/master/blog/base/wechat/wechatpay.png" alt="WeChat Pay" style="width: 200px; height: 200px; text-align: center;">
            <!-- <p>Wechat</p> -->
            </div>
            <div id="alipay" style="display: inline-block">
                <img id="alipay_qr" src="https://github.com/CatherineLiyuankun/PictureBed/raw/master/blog/base/alipay.png" alt="Alipay" style="width: 200px; height: 200px; text-align: center;">
            <!-- <p>Alipay</p> -->
            </div>
        </div>
    </div>
</div>


                    <! -- 添加版权信息 -->
<div class="article-footer-copyright">
  <div><b>本文标题: </b><a href="/Kubernetes-CKS-知识点-练习题.html" target="_blank" title="Kubernetes CKS 知识点&amp;练习题">Kubernetes CKS 知识点&amp;练习题</a></div>
  <div><b>本文链接: </b><a href="/Kubernetes-CKS-知识点-练习题.html" target="_blank" title="Kubernetes CKS 知识点&amp;练习题">http://liyuankun.top/Kubernetes-CKS-知识点-练习题.html</a>.</div>
  <div>本文由<a href="/index.html" target="_blank" title="Yuankun Li">Yuankun Li</a>创作和发表,采用<b>BY</b>-<b>NC</b>-<b>SA</b>国际许可协议进行许可,转载请注明作者及出处。</div>
</div>

                    
                    <hr>
                    <!-- Pager -->
                    <ul class="pager">
                        
                            <li class="previous">
                                <a href="/OpenJS-Node-js-Application-Developer-JSNAD-专业认证考试.html" rel="external nofollow" data-toggle="tooltip" data-placement="top" title="OpenJS Node.js Application Developer (JSNAD)专业认证考试">&larr; Previous Post</a>
                            </li>
                        
                        
                            <li class="next">
                                <a href="/图片处理软件推荐.html" rel="external nofollow" data-toggle="tooltip" data-placement="top" title="图片处理软件推荐">Next Post &rarr;</a>
                            </li>
                        
                    </ul>

                    <!-- Duoshuo Comment Share -->
                    

                    <!-- Duoshuo Comment -->
                    

                    <!-- Disqus Comment -->
                    <!-- disqus comment -->

    <div class="disqus_comment">
        <div id="disqus_thread" class="disqus-thread"></div>
    </div>


                    <!-- Git Comment -->
                    <!-- gitment -->

    <hr>
    <div class="git_comment" id="git_comment">
        
            <div onclick="document.getElementById('gitment-display-button').style.display = 'none';document.getElementById('gitment-container').style.display = 'block';renderGitment();" id="gitment-display-button">show git comment</div>
            <div id="gitment-container" style="display:none"></div>
        
    </div>
    <hr>

                </div>
                
                <!-- Tabe of Content -->
                <!-- Table of Contents -->

    
      <aside id="sidebar">
        <div id="toc" class="toc-article">
        <strong class="toc-title">Contents</strong>
        
          <ol class="toc-nav"><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#pod-security-policies-psp"><span class="toc-nav-number">1.</span> <span class="toc-nav-text">Pod Security Policies(PSP)</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#apparmor"><span class="toc-nav-number">2.</span> <span class="toc-nav-text">AppArmor</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#apiserver-crash"><span class="toc-nav-number">3.</span> <span class="toc-nav-text">Apiserver Crash</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#configure-a-wrong-argument"><span class="toc-nav-number">3.1.</span> <span class="toc-nav-text">Configure a wrong argument</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#misconfigure-etcd-connection"><span class="toc-nav-number">3.2.</span> <span class="toc-nav-text">Misconfigure ETCD connection</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#invalid-apiserver-manifest-yaml"><span class="toc-nav-number">3.3.</span> <span class="toc-nav-text">Invalid Apiserver Manifest YAML</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#apiserver-misconfigured"><span class="toc-nav-number">4.</span> <span class="toc-nav-text">Apiserver Misconfigured</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#issues"><span class="toc-nav-number">4.1.</span> <span class="toc-nav-text">Issues</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#solution-1"><span class="toc-nav-number">4.2.</span> <span class="toc-nav-text">Solution 1</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#solution-2"><span class="toc-nav-number">4.3.</span> <span class="toc-nav-text">Solution 2</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#solution-3"><span class="toc-nav-number">4.4.</span> <span class="toc-nav-text">Solution 3</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#apiserver-noderestriction"><span class="toc-nav-number">5.</span> <span class="toc-nav-text">Apiserver NodeRestriction</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#verify-the-issue"><span class="toc-nav-number">5.1.</span> <span class="toc-nav-text">Verify the issue</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#tip"><span class="toc-nav-number">5.1.1.</span> <span class="toc-nav-text">Tip</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#solution"><span class="toc-nav-number">5.1.2.</span> <span class="toc-nav-text">Solution</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#enable-the-noderestriction-admission-controller"><span class="toc-nav-number">5.2.</span> <span class="toc-nav-text">Enable the NodeRestriction Admission Controller</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#imagepolicywebhook"><span class="toc-nav-number">6.</span> <span class="toc-nav-text">ImagePolicyWebhook</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#complete-the-imagepolicywebhook-setup"><span class="toc-nav-number">6.1.</span> <span class="toc-nav-text">Complete the ImagePolicyWebhook setup</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#kube-bench"><span class="toc-nav-number">7.</span> <span class="toc-nav-text">kube-bench</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#apiserver-should-be-more-conform-to-cis"><span class="toc-nav-number">7.1.</span> <span class="toc-nav-text">Apiserver should be more conform to CIS</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#controllermanager-should-be-more-conform-to-cis"><span class="toc-nav-number">7.2.</span> <span class="toc-nav-text">ControllerManager should be more conform to CIS</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#pki-directory-should-be-more-conform-to-cis"><span class="toc-nav-number">7.3.</span> <span class="toc-nav-text">PKI directory should be more conform to CIS</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#trivy"><span class="toc-nav-number">8.</span> <span class="toc-nav-text">Trivy</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#use-trivy-to-scan-images-for-known-vulnerabilities"><span class="toc-nav-number">8.1.</span> <span class="toc-nav-text">Use trivy to scan images for known vulnerabilities</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#falco"><span class="toc-nav-number">9.</span> <span class="toc-nav-text">Falco</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#investigate-a-falco-rule"><span class="toc-nav-number">9.1.</span> <span class="toc-nav-text">Investigate a Falco Rule</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#tip-v2"><span class="toc-nav-number">9.1.1.</span> <span class="toc-nav-text">Tip</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#solution-v2"><span class="toc-nav-number">9.1.2.</span> <span class="toc-nav-text">Solution</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#change-a-falco-rule"><span class="toc-nav-number">9.2.</span> <span class="toc-nav-text">Change a Falco Rule</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#tip-v3"><span class="toc-nav-number">9.2.1.</span> <span class="toc-nav-text">Tip</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#solution-v3"><span class="toc-nav-number">9.2.2.</span> <span class="toc-nav-text">Solution</span></a></li></ol></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#networkpolicy-namespace-selector"><span class="toc-nav-number">10.</span> <span class="toc-nav-text">NetworkPolicy - namespace selector</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#tip-v4"><span class="toc-nav-number">10.1.</span> <span class="toc-nav-text">Tip</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#solution-v4"><span class="toc-nav-number">10.2.</span> <span class="toc-nav-text">Solution</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#networkpolicy-metadata-protection"><span class="toc-nav-number">11.</span> <span class="toc-nav-text">NetworkPolicy - Metadata Protection</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#rbac-user"><span class="toc-nav-number">12.</span> <span class="toc-nav-text">RBAC - user</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#solution-v5"><span class="toc-nav-number">12.1.</span> <span class="toc-nav-text">Solution</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#verify"><span class="toc-nav-number">12.2.</span> <span class="toc-nav-text">Verify</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#rbac-serviceaccount"><span class="toc-nav-number">13.</span> <span class="toc-nav-text">RBAC - ServiceAccount</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#solution-v6"><span class="toc-nav-number">13.1.</span> <span class="toc-nav-text">Solution</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#secret-etcd-encryption"><span class="toc-nav-number">14.</span> <span class="toc-nav-text">Secret - ETCD Encryption</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#enable-etcd-encryption"><span class="toc-nav-number">14.1.</span> <span class="toc-nav-text">Enable ETCD Encryption</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#solution-v7"><span class="toc-nav-number">14.1.1.</span> <span class="toc-nav-text">Solution</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#encrypt-existing-secrets"><span class="toc-nav-number">14.2.</span> <span class="toc-nav-text">Encrypt existing Secrets</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#tip-v5"><span class="toc-nav-number">14.2.1.</span> <span class="toc-nav-text">Tip</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#solution-v8"><span class="toc-nav-number">14.2.2.</span> <span class="toc-nav-text">Solution</span></a></li></ol></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#secret-read-and-decode"><span class="toc-nav-number">15.</span> <span class="toc-nav-text">Secret - Read and Decode</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#read-and-decode-the-secrets-in-namespace-one"><span class="toc-nav-number">15.1.</span> <span class="toc-nav-text">Read and decode the Secrets in Namespace one</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#solution-v9"><span class="toc-nav-number">15.1.1.</span> <span class="toc-nav-text">Solution</span></a></li></ol></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#privilege-escalation-containers"><span class="toc-nav-number">16.</span> <span class="toc-nav-text">Privilege Escalation Containers</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#solution-v10"><span class="toc-nav-number">16.1.</span> <span class="toc-nav-text">Solution</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#privileged-containers"><span class="toc-nav-number">17.</span> <span class="toc-nav-text">Privileged Containers</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#create-a-privileged-pod"><span class="toc-nav-number">17.1.</span> <span class="toc-nav-text">Create a privileged Pod</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#solution-v11"><span class="toc-nav-number">17.1.1.</span> <span class="toc-nav-text">Solution</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#create-a-privileged-statefulset"><span class="toc-nav-number">17.2.</span> <span class="toc-nav-text">Create a privileged StatefulSet</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#solution-v12"><span class="toc-nav-number">17.2.1.</span> <span class="toc-nav-text">Solution</span></a></li></ol></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#container-hardening"><span class="toc-nav-number">18.</span> <span class="toc-nav-text">Container Hardening</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#solution-v13"><span class="toc-nav-number">18.1.</span> <span class="toc-nav-text">Solution</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#container-image-footprint-user"><span class="toc-nav-number">19.</span> <span class="toc-nav-text">Container Image Footprint User</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#run-the-default-dockerfile"><span class="toc-nav-number">19.1.</span> <span class="toc-nav-text">Run the default Dockerfile</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#solution-v14"><span class="toc-nav-number">19.1.1.</span> <span class="toc-nav-text">Solution</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#run-container-as-user"><span class="toc-nav-number">19.2.</span> <span class="toc-nav-text">Run container as user</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#solution-v15"><span class="toc-nav-number">19.2.1.</span> <span class="toc-nav-text">Solution</span></a></li></ol></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#runtimeclass-gvisor"><span class="toc-nav-number">20.</span> <span class="toc-nav-text">RuntimeClass - gVisor</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#install-and-configure-gvisor"><span class="toc-nav-number">20.1.</span> <span class="toc-nav-text">Install and configure gVisor</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#solution-v16"><span class="toc-nav-number">20.1.1.</span> <span class="toc-nav-text">Solution</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#create-runtimeclass-and-pod-to-use-gvisor"><span class="toc-nav-number">20.2.</span> <span class="toc-nav-text">Create RuntimeClass and Pod to use gVisor</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#tip-v6"><span class="toc-nav-number">20.2.1.</span> <span class="toc-nav-text">Tip</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#solution-v17"><span class="toc-nav-number">20.2.2.</span> <span class="toc-nav-text">Solution</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#verify-v2"><span class="toc-nav-number">20.2.3.</span> <span class="toc-nav-text">Verify</span></a></li></ol></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#certificatesigningrequests-sign-manually"><span class="toc-nav-number">21.</span> <span class="toc-nav-text">CertificateSigningRequests sign manually</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#create-key-and-csr"><span class="toc-nav-number">21.1.</span> <span class="toc-nav-text">Create KEY and CSR</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#explanation"><span class="toc-nav-number">21.1.1.</span> <span class="toc-nav-text">Explanation</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#tip-v7"><span class="toc-nav-number">21.1.2.</span> <span class="toc-nav-text">Tip</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#solution-v18"><span class="toc-nav-number">21.1.3.</span> <span class="toc-nav-text">Solution</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#manual-signing"><span class="toc-nav-number">21.2.</span> <span class="toc-nav-text">Manual signing</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#tip-1"><span class="toc-nav-number">21.2.1.</span> <span class="toc-nav-text">Tip 1</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#tip-2"><span class="toc-nav-number">21.2.2.</span> <span class="toc-nav-text">Tip 2</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#solution-1-v2"><span class="toc-nav-number">21.2.3.</span> <span class="toc-nav-text">Solution 1</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#solution-2-v2"><span class="toc-nav-number">21.2.4.</span> <span class="toc-nav-text">Solution 2</span></a></li></ol></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#certificatesigningrequests-sign-via-api"><span class="toc-nav-number">22.</span> <span class="toc-nav-text">CertificateSigningRequests sign via API</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#create-key-and-csr-v2"><span class="toc-nav-number">22.1.</span> <span class="toc-nav-text">Create KEY and CSR</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#tip-v8"><span class="toc-nav-number">22.1.1.</span> <span class="toc-nav-text">Tip</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#solution-v19"><span class="toc-nav-number">22.1.2.</span> <span class="toc-nav-text">Solution</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#signing-via-api"><span class="toc-nav-number">22.2.</span> <span class="toc-nav-text">Signing via API</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#certificatesigningrequest-template"><span class="toc-nav-number">22.2.1.</span> <span class="toc-nav-text">CertificateSigningRequest template</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#solution-v20"><span class="toc-nav-number">22.2.2.</span> <span class="toc-nav-text">Solution</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#use-the-crt"><span class="toc-nav-number">22.2.3.</span> <span class="toc-nav-text">Use the CRT</span></a></li></ol></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#image-use-digest"><span class="toc-nav-number">23.</span> <span class="toc-nav-text">Image Use Digest</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#use-an-image-digest-instead-of-tag"><span class="toc-nav-number">23.1.</span> <span class="toc-nav-text">Use an image digest instead of tag</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#solution-v21"><span class="toc-nav-number">23.1.1.</span> <span class="toc-nav-text">Solution</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#switch-deployment-from-using-tag-to-digest"><span class="toc-nav-number">23.2.</span> <span class="toc-nav-text">Switch deployment from using tag to digest</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#solution-v22"><span class="toc-nav-number">23.2.1.</span> <span class="toc-nav-text">Solution</span></a></li></ol></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#securitycontext-immutability-readonly-filesystem"><span class="toc-nav-number">24.</span> <span class="toc-nav-text">securityContext - Immutability Readonly Filesystem</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#create-a-pod-with-read-only-filesystem"><span class="toc-nav-number">24.1.</span> <span class="toc-nav-text">Create a Pod with read-only filesystem</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#solution-v23"><span class="toc-nav-number">24.1.1.</span> <span class="toc-nav-text">Solution</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#fix-existing-nginx-deployment-to-work-with-read-only-filesystem"><span class="toc-nav-number">24.2.</span> <span class="toc-nav-text">Fix existing Nginx Deployment to work with read-only filesystem</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#solution-v24"><span class="toc-nav-number">24.2.1.</span> <span class="toc-nav-text">Solution</span></a></li></ol></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#static-manual-analysis-k8s"><span class="toc-nav-number">25.</span> <span class="toc-nav-text">Static Manual Analysis K8s</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#analyse-k8s-pod-yaml"><span class="toc-nav-number">25.1.</span> <span class="toc-nav-text">Analyse K8s Pod YAML</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#tip-v9"><span class="toc-nav-number">25.1.1.</span> <span class="toc-nav-text">Tip</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#solution-v25"><span class="toc-nav-number">25.1.2.</span> <span class="toc-nav-text">Solution</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#analyse-k8s-deployment-yaml"><span class="toc-nav-number">25.2.</span> <span class="toc-nav-text">Analyse K8s Deployment YAML</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#tip-v10"><span class="toc-nav-number">25.2.1.</span> <span class="toc-nav-text">Tip</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#solution-v26"><span class="toc-nav-number">25.2.2.</span> <span class="toc-nav-text">Solution</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#analyse-k8s-statefulset-yaml"><span class="toc-nav-number">25.3.</span> <span class="toc-nav-text">Analyse K8s StatefulSet YAML</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#tip-v11"><span class="toc-nav-number">25.3.1.</span> <span class="toc-nav-text">Tip</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#solution-v27"><span class="toc-nav-number">25.3.2.</span> <span class="toc-nav-text">Solution</span></a></li></ol></li></ol></li></ol>
        
        </div>
      </aside>
    

                    
                <!-- Sidebar Container Below-->
                <div class="
    col-lg-8 col-lg-offset-2
    col-md-10 col-md-offset-1
    sidebar-container">
    
        
    
        
    
        
    
        
            
  <h5>RECENT POSTS</h5>
  <div class="widget">
    <ul>
      
        <li>
          <a href="/awesome-tools.html">程序猿的那些好用工具</a>
        </li>
      
        <li>
          <a href="/计算机英语-virus-worm-Spyware-Ransomware-Trojan-horse.html">计算机英语-virus,worm,Spyware,Ransomware,Trojan horse</a>
        </li>
      
        <li>
          <a href="/浏览器报错“localhost-sent-an-invalid-response-ERR-SSL-PROTOCOL-ERROR”.html">浏览器报错“localhost sent an invalid response.ERR_SSL_PROTOCOL_ERROR”</a>
        </li>
      
        <li>
          <a href="/JSON-Web-Token-JWT-入门教程.html">JSON Web Token (JWT) 入门教程</a>
        </li>
      
        <li>
          <a href="/Develop-LLM-powered-applications-with-LangChain-Udemy-Course.html">Develop LLM powered applications with LangChain - Udemy Course</a>
        </li>
      
    </ul>
  </div>

            <hr>
        
    
        
            <!-- Friends Blog -->

<h5>FRIENDS</h5>
<ul class="list-inline">

    
        <li><a href="https://blog.csdn.net/muzilanlan" target="_blank">CSDN</a></li>
    
        <li><a href="https://www.jianshu.com/u/6b421fa23669" target="_blank">简书</a></li>
    
</ul>

            <hr>
        
    
        
    
</div>
            </div>
        </div>
    </article>
</div>


<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>
<!-- anchor-js, Doc:http://bryanbraun.github.io/anchorjs/ -->
<script>
    async("https://cdn.bootcss.com/anchor-js/1.1.1/anchor.min.js",function(){
        anchors.options = {
          visible: 'hover',
          placement: 'left',
          icon: 'ℒ'
        };
        anchors.add().remove('.intro-header h1').remove('.subheading').remove('.sidebar-container h5');
    })
</script>
<!-- Read more, 微信解锁博客 https://openwrite.cn/openwrite/openwrite-readmore/-->
<script src="https://my.openwrite.cn/js/readmore.js" type="text/javascript"></script>
<script>
    const btw = new BTWPlugin();
    btw.init({
        id: 'container',
        blogId: '19965-1582033785898-401',
        name: '岚坤爷',
        qrcode: 'https://github.com/CatherineLiyuankun/PictureBed/raw/master/blog/base/wechat/wechat-public.png',
        keyword: 'vip',
    });
    // 加英文版翻译
    const readMoreBtn = document.querySelector('#read-more-btn');
    const addEnglish = () => {
        const element = document.querySelector('#btw-modal-header');
        element.innerHTML = element.innerHTML + `<p id="btw-modal-header-en" style="margin-top: 10px; line-height: 1.8; font-size: 13px; color: #0085a1;">
            Scan the QR code to follow the WeChat public account: <strong>岚坤爷</strong><br>
            Send message:<strong> vip</strong><br>
            Get a verification code that permanently unlocks all articles on this site`;
        const input = document.querySelector('#btw-modal-input');
        input.setAttribute('placeholder', '请输入验证码 Input verification code');
        const submit = document.querySelector('#btw-submit-btn');
        submit.innerHTML = '提交 Submit';
    };

    readMoreBtn.addEventListener('click', () => {
        setTimeout(addEnglish, 10);
    });
</script>

<style>
    /* place left on bigger screen */
    @media all and (min-width: 800px) {
        .anchorjs-link{
            position: absolute;
            left: -0.75em;
            font-size: 1.1em;
            margin-top : -0.1em;
        }
    }
</style>



    <!-- Footer -->
    <!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-1 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                
                    <li>
                        <a href="/atom.xml">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-rss fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                

                
                    <li>
                        <a target="_blank"  href="https://github.com/catherineliyuankun">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                

                
                    <li>
                        <a target="_blank"  href="https://www.linkedin.com/in/liyuankun">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-linkedin fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                

                
                    <li>
                        <a target="_blank" href="https://www.zhihu.com/people/muzilan">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa  fa-stack-1x fa-inverse">知</i>
                            </span>
                        </a>
                    </li>
                

                
                    <li>
                        <a target="_blank" href="https://www.jianshu.com/u/6b421fa23669">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa  fa-stack-1x fa-inverse">简</i>
                            </span>
                        </a>
                    </li>
                

                

                
                    <li>
                        <a target="_blank" href="mailto:muzilan1@qq.com">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-envelope fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                

                
                    <li>
                        <a target="_blank" href="https://twitter.com/CatherineLiYK">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                

                
                    <li>
                        <a target="_blank" href="https://www.facebook.com/liyuankun">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-facebook fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                

                </ul>
                <p class="copyright text-muted">
                    Copyright &copy; Yuankun Li 2025 
                    <br>
                    Theme by <a href="https://github.com/CatherineLiyuankun">Li, Yuankun</a> | 
                    <iframe
                        style="margin-left: 2px; margin-bottom:-5px;"
                        frameborder="0" scrolling="0" width="91px" height="20px"
                        src="https://ghbtns.com/github-btn.html?user=catherineliyuankun&repo=hexo-theme-zilan&type=star&count=true" >
                    </iframe>
                </p>
            </div>
        </div>
    </div>
</footer>

<!-- jQuery -->
<script src="/js/jquery.min.js"></script>

<!-- Bootstrap Core JavaScript -->
<script src="/js/bootstrap.min.js"></script>

<!-- Custom Theme JavaScript -->
<script src="/js/hux-blog.min.js"></script>


<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>

<!-- 
     Because of the native support for backtick-style fenced code blocks 
     right within the Markdown is landed in Github Pages, 
     From V1.6, There is no need for Highlight.js, 
     so Huxblog drops it officially.

     - https://github.com/blog/2100-github-pages-now-faster-and-simpler-with-jekyll-3-0  
     - https://help.github.com/articles/creating-and-highlighting-code-blocks/    
-->
<!--
    <script>
        async("http://cdn.bootcss.com/highlight.js/8.6/highlight.min.js", function(){
            hljs.initHighlightingOnLoad();
        })
    </script>
    <link href="http://cdn.bootcss.com/highlight.js/8.6/styles/github.min.css" rel="stylesheet">
-->


<!-- jquery.tagcloud.js -->
<script>
    // only load tagcloud.js in tag.html
    if($('#tag_cloud').length !== 0){
        async("http://liyuankun.top/js/jquery.tagcloud.js",function(){
            $.fn.tagcloud.defaults = {
                //size: {start: 1, end: 1, unit: 'em'},
                color: {start: '#bbbbee', end: '#0085a1'},
            };
            $('#tag_cloud a').tagcloud();
        })
    }
</script>

<!--fastClick.js -->
<script>
    async("https://cdn.bootcss.com/fastclick/1.0.6/fastclick.min.js", function(){
        var $nav = document.querySelector("nav");
        if($nav) FastClick.attach($nav);
    })
</script>


<!-- Google Analytics -->


<script>
    // dynamic User by Hux
    var _gaId = 'UA-XXXXXXXX-X';
    var _gaDomain = 'yoursite';

    // Originial
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', _gaId, _gaDomain);
    ga('send', 'pageview');
</script>




<!-- Baidu Tongji -->





    <!-- Fork me on GitHub -->
    
       
    <!-- Search -->
    <!-- {% include 'tinysou.swig' %}
 {% include 'localsearch.swig' %}
 {% include 'algolia-search/assets.swig' %} -->


  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = 'search.xml';
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = '/' + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        // dataType: isXml ? "xml" : "json",
        // dataType: "binary",
        // contentType: "text/xml",
        dataType: "text", // Fix Bug: xml parser error
        async: true,
        data: "{}",
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-cover');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if (!input || !resultContent) {
            // Fix Bug: add /zilan/layout/_partial/search/localsearch.ejs inside "site-search"
              $(".site-search")
              .append(
                  '<div class="popup search-popup local-search-popup">' +
                  '<div class="local-search-header clearfix">' +
                    '<span class="search-icon">' +
                      '<i class="fa fa-search"></i>' +
                  '</span>' +
                    '<span class="popup-btn-close">' +
                      '<i class="fa fa-times-circle"></i>' +
                    '</span>' +
                    '<div class="local-search-input-wrapper">' +
                      '<input autocomplete="off"' +
                            'placeholder="search" spellcheck="false"' +
                            'type="text" id="local-search-input">' +
                    '</div>' +
                  '</div>' +
                  '<div id="local-search-result"></div>' +
                '</div>');
            input = document.getElementById("local-search-input");
            resultContent = document.getElementById("local-search-result");
            // Fix Bug: close not work
            var searchClose = document.querySelector(".popup-btn-close");
            searchClose.addEventListener('click', onPopupClose);
          }
          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        },
        error: function (jqXHR, textStatus, errorThrown) {
            /*弹出jqXHR对象的信息*/
            alert(jqXHR.responseText);
            alert(jqXHR.status);
            alert(jqXHR.readyState);
            alert(jqXHR.statusText);
            /*弹出其他两个参数的信息*/
            alert(textStatus);
            alert(errorThrown);
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });

    var registerESCKeyEvent =  function () {
      $(document).on('keyup', function (event) {
        var shouldDismissSearchPopup = event.which === 27 &&
          $('.search-popup').is(':visible');
        if (shouldDismissSearchPopup) {
          $('.search-popup').hide();
          $('.search-popup-overlay').remove();
          $('body').css('overflow', '');
        }
      });
    };
    registerESCKeyEvent();
  </script>





    <!-- Share -->
      
    <link rel="stylesheet" href="/lib/needsharebutton/needsharebutton.css">
    <script src="/lib/needsharebutton/needsharebutton.js"></script>

    
      <script>
          var pbOptions = {};
          var iconStyle = "light";
          var boxForm = "horizontal";
          var position = "bottom";
          var networks = "Wechat,Weibo,Douban,Twitter,Facebook,Reddit,Linkedin,Evernote";
          pbOptions["iconStyle"] = iconStyle;
          pbOptions["boxForm"] = boxForm;
          pbOptions["position"] = position;
          pbOptions["networks"] = networks;
          
          new needShareButton('#needsharebutton-postbottom', pbOptions);
      </script>
    

    
      <script>
          var pbOptions = {};
          var iconStyle = "light";
          var boxForm = "horizontal";
          var position = "middleRight";
          var networks = "Wechat,Weibo,Douban,Twitter,Facebook,Reddit,Linkedin,Evernote";
          pbOptions["iconStyle"] = iconStyle;
          pbOptions["boxForm"] = boxForm;
          pbOptions["position"] = position;
          pbOptions["networks"] = networks;
          
          new needShareButton('#needsharebutton-postbottom', pbOptions);
      </script>
    

    
      <script>
          var flOptions = {};
          var iconStyle = "box";
          var boxForm = "horizontal";
          var position = "middleRight";
          var networks = "Wechat,Weibo,Douban,Twitter,Facebook,Reddit,Linkedin,Evernote";
          flOptions["iconStyle"] = iconStyle;
          flOptions["boxForm"] = boxForm;
          flOptions["position"] = position;
          flOptions["networks"] = networks;

          new needShareButton('#needsharebutton-float', flOptions);
      </script>
    


    <!-- Share float -->
    
      <div id="needsharebutton-float">
        <span class="btn">
          <i class="fa fa-share-alt fa-inverse" aria-hidden="true"></i>
        </span>
      </div>
      

    <!-- Git Comment -->
    
    
    <!-- LOCAL: You can save these files to your site and update links -->
        
            <link rel="stylesheet" href="https://aimingoo.github.io/gitmint/style/default.css">
            <script src="https://aimingoo.github.io/gitmint/dist/gitmint.browser.js"></script>
        
    <!-- END LOCAL -->
        
        <style>
            a.gitment-editor-footer-tip { display: none; }
            .gitment-container.gitment-footer-container { display: none; }
        </style>
        

        
        <script type="text/javascript">
            var option = {
                id: window.location.pathname,
                owner: 'CatherineLiyuankun',
                repo: 'gitment-comments',
                oauth: {
                    client_id: 'f3a0c1c7153576e1ab6c'
                }
            };
            if(true) {
                option.lang = "" || navigator.language || navigator.systemLanguage || navigator.userLanguage;
            }
            if (true && ( || false)) {
                option.oauth.redirect_protocol = '';
            }
            if (true && ( || false)) {
                option.oauth.proxy_gateway = '';
            } else {
                option.oauth.client_secret = 'bedf5010df925fa0e02e8be9399a64caac3d2b4e';
            }

            function renderGitment(){
                var gitment;
                if (true) {
                    gitment = new Gitmint(option);
                } else {
                    gitment = new Gitment(option);
                }
                gitment.render('gitment-container');
            }

            if(!true) {
                renderGitment();
            } else {
                function showGitment(){
                    document.getElementById("gitment-display-button").style.display = "none";
                    document.getElementById("gitment-container").style.display = "block";
                    renderGitment();
                }
            }
        </script>
        
    



    <!-- Disqus Comment -->
    
    <!-- disqus embedded js code start (one page only need to embed once) -->
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES * * */
        var disqus_shortname = "lyk-1";
        var disqus_identifier = "http://liyuankun.top/Kubernetes-CKS-知识点-练习题.html";
        var disqus_url = "http://liyuankun.top/Kubernetes-CKS-知识点-练习题.html";

        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();

    </script>
    <!-- disqus embedded js code start end -->

    
    <!-- Duoshuo Comment -->
    

    <!-- Search popup-->
    
    
      <div class="site-search">
      <!-- {% if theme.algolia_search.enable %}
  {% include '../_third-party/search/algolia-search/dom.swig' %}
{% elseif theme.swiftype_key %}
  {% include 'search/swiftype.swig' %}
{% elseif theme.tinysou_Key %}
  {% include 'search/tinysou.swig' %}
{% elseif theme.local_search.enable %}
  {% include 'search/localsearch.swig' %}
{% endif %} -->

<div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="search" spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



      </div>
    
    
	<a id="rocket" href="#top" class="" rel="external nofollow"></a>
	<script type="text/javascript" src="/js/totop.js?v=1.0.0" async=""></script>
  <script type="text/javascript" src="/js/toc.js?v=1.0.0" async=""></script>

  <!-- Markdown math -->
   
   
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });
    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });
    </script>
    <script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
  



  <!-- Fancybox -->
  
      <link rel="stylesheet" href="/lib/fancybox/jquery.fancybox.css">
      <script src="/lib/fancybox/jquery.fancybox.pack.js"></script>
      <script src="/js/wrapImage.js"></script>
  
  <!-- Migrate from head to bottom, no longer block render and still work --><!-- hexo-inject:begin --><!-- Begin: Injected MathJax -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({"tex2jax":{"inlineMath":[["$","$"],["\\(","\\)"]],"skipTags":["script","noscript","style","textarea","pre","code"],"processEscapes":true},"TeX":{"equationNumbers":{"autoNumber":"AMS"}}});
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });
</script>

<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js">
</script>
<!-- End: Injected MathJax -->
<!-- hexo-inject:end -->

</body>

</html>
